<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Perwalian STAI AL-MAS'UDIYAH SUKABUMI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a8a',
                        secondary: '#059669',
                        accent: '#dc2626',
                        dark: '#1f2937',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif']
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Animation for modals */
        .modal-enter {
            animation: fadeIn 0.3s ease-out;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans antialiased">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg border-b border-gray-200 shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://iili.io/KdXnlX2.png" alt="Logo STAI AL-MAS'UDIYAH" class="w-12 h-12 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-12 h-12 bg-primary rounded-lg items-center justify-center hidden">
                        <span class="text-white font-bold text-xl">S</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Sistem Perwalian</h1>
                        <p class="text-gray-600 text-sm font-medium">STAI AL-MAS'UDIYAH SUKABUMI</p>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <div class="text-right">
                        <p class="text-sm text-gray-500 font-medium">Selamat Datang</p>
                        <p class="font-semibold text-gray-900" id="userName">Pilih Role Anda</p>
                    </div>
                    <button id="logoutButton" onclick="logout()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-gray-300 hidden">
                        Keluar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Role Selection -->
    <div id="roleSelection" class="container mx-auto px-6 py-12">
        <div class="max-w-5xl mx-auto">
            <div class="text-center mb-16">
                <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600 mb-4 pb-2">SELAMAT DATANG</h2>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">Pilih peran Anda untuk melanjutkan dan mengakses fitur yang relevan.</p>
            </div>
            
            <div class="grid md:grid-cols-3 gap-8">
                <!-- Mahasiswa Card -->
                <div class="group bg-white rounded-2xl shadow-lg hover:shadow-card-hover transition-all duration-300 p-8 cursor-pointer border border-gray-100 hover:-translate-y-2" onclick="showMahasiswaLoginModal()">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-3">Mahasiswa</h3>
                        <p class="text-gray-600 leading-relaxed">Akses dashboard, profil akademik, dan konsultasi dengan dosen wali</p>
                        <div class="mt-6 inline-flex items-center text-blue-600 font-medium group-hover:text-blue-700">
                            <span>Masuk sebagai Mahasiswa</span>
                            <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Dosen Wali Card -->
                <div class="group bg-white rounded-2xl shadow-lg hover:shadow-card-hover transition-all duration-300 p-8 cursor-pointer border border-gray-100 hover:-translate-y-2" onclick="showDosenLoginModal()">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-emerald-400 to-green-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-green-500/30 group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-3">Dosen Wali</h3>
                        <p class="text-gray-600 leading-relaxed">Kelola mahasiswa bimbingan, persetujuan KRS, dan dokumentasi perwalian</p>
                        <div class="mt-6 inline-flex items-center text-green-600 font-medium group-hover:text-green-700">
                            <span>Masuk sebagai Dosen</span>
                            <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Admin Card -->
                <div class="group bg-white rounded-2xl shadow-lg hover:shadow-card-hover transition-all duration-300 p-8 cursor-pointer border border-gray-100 hover:-translate-y-2" onclick="selectRole('admin')">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-violet-400 to-purple-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-purple-500/30 group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-3">Admin/Tata Usaha</h3>
                        <p class="text-gray-600 leading-relaxed">Manajemen pengguna, data akademik, dan laporan sistem</p>
                        <div class="mt-6 inline-flex items-center text-purple-600 font-medium group-hover:text-purple-700">
                            <span>Masuk sebagai Admin</span>
                            <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard (Hidden initially) -->
    <div id="mainDashboard" class="hidden container mx-auto px-6 py-8">
        <!-- Navigation Menu -->
        <div class="bg-white rounded-2xl shadow-card border border-gray-100 mb-8">
            <div class="p-8">
                <h3 class="text-2xl font-bold text-gray-900 mb-6" id="menuTitle">Menu Utama</h3>
                <div id="menuContainer" class="grid lg:grid-cols-3 gap-4">
                    <!-- Menu items will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div id="contentArea" class="bg-white rounded-2xl shadow-card border border-gray-100 p-8 min-h-[50vh]">
            <div class="text-center py-16">
                <div class="w-32 h-32 bg-gradient-to-br from-blue-50 to-blue-100 rounded-3xl flex items-center justify-center mx-auto mb-6">
                    <svg class="w-16 h-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-3">Selamat Datang di Sistem Perwalian</h3>
                <p class="text-gray-600 text-lg max-w-md mx-auto">Pilih menu di atas untuk mulai menggunakan sistem perwalian digital</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-16">
        <div class="container mx-auto px-6 py-12">
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <div class="flex items-center space-x-3 mb-4">
                        <img src="https://iili.io/KdXnlX2.png" alt="Logo STAI AL-MAS'UDIYAH" class="w-8 h-8 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-8 h-8 bg-primary rounded-lg items-center justify-center hidden">
                            <span class="text-white font-bold text-sm">S</span>
                        </div>
                        <h4 class="text-xl font-bold text-gray-900">STAI AL-MAS'UDIYAH SUKABUMI</h4>
                    </div>
                    <div class="space-y-2 text-gray-600">
                        <p class="flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
                            </svg>
                            <span class="font-medium">Website:</span> staimas.ac.id
                        </p>
                        <p class="flex items-start">
                            <svg class="w-4 h-4 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span><span class="font-medium">Alamat:</span> Jl. Sukabumi-Sagaranten Km. 26 Kp. Buniayu Desa Kertaangsana, Kec. Nyalindung Sukabumi</span>
                        </p>
                    </div>
                </div>
                <div class="md:text-right">
                    <div class="space-y-2">
                        <p class="text-gray-500 text-sm">Â© 2024 STAI AL-MAS'UDIYAH SUKABUMI</p>
                        <p class="text-gray-500 text-sm">Sistem Perwalian Digital</p>
                        <div class="flex md:justify-end space-x-4 mt-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                âœ“ Sistem Aktif
                            </span>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                v2.0.1
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modals Container -->
    <div id="modalsContainer"></div>
    
    <!-- Custom Alert/Notification -->
    <div id="customAlert" class="hidden fixed top-5 right-5 z-50 bg-green-500 text-white py-3 px-5 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full">
        <p id="customAlertMessage"></p>
    </div>


    <script>
        let currentRole = '';
        let currentDosen = null;
        let currentMahasiswa = null;
        let currentEditingUserId = null;
        let currentEditingCourseId = null;
        let currentEditingScheduleId = null;

        // GANTI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
        const SPREADSHEET_URL = 'https://script.google.com/macros/s/AKfycbzVLJa3MefhrFovWOn6ZeL_bTjePzPNBPRvaavBNzjYy-LBTpyWf-5AatMT3jaCCn5_GA/exec'; 
        // FUNGSI BARU UNTUK MENGIRIM DATA KE GOOGLE SHEET
async function kirimCatatanKeSheet(data) {
    if (!SPREADSHEET_URL) {
        console.error("URL Google Apps Script belum diatur!");
        return; // Hentikan fungsi jika URL kosong
    }

    const formData = new FormData();
    formData.append('namaDosen', data.namaDosen);
    formData.append('nipDosen', data.nipDosen);
    formData.append('namaMahasiswa', data.namaMahasiswa);
    formData.append('nimMahasiswa', data.nimMahasiswa);
    formData.append('tanggalCatatan', data.tanggalCatatan);
    formData.append('isiCatatan', data.isiCatatan);

    try {
        const response = await fetch(SPREADSHEET_URL, {
            method: 'POST',
            body: formData,
        });
        const result = await response.json();
        if (result.result === "success") {
            console.log("Catatan berhasil dikirim ke Google Sheet.");
            // Tidak perlu menampilkan alert di sini karena sudah ada alert bawaan
        } else {
             console.error("Gagal mengirim ke Google Sheet:", result);
        }
    } catch (error) {
    console.error('Terjadi error saat mengirim data:', error);
    // AKTIFKAN BARIS DI BAWAH INI untuk menampilkan notifikasi error di layar
    showAlert('Gagal sinkronisasi. Cek koneksi atau pengaturan skrip.', 'error');
}   
}

        const menuData = {
            mahasiswa: {
                title: 'Menu Mahasiswa ðŸ§‘â€ðŸŽ“',
                items: [
                    { name: 'Dashboard', icon: 'ðŸ“Š', desc: 'Ringkasan informasi akademik dan perwalian' },
                    { name: 'Profil Akademik', icon: 'ðŸ“š', desc: 'Transkrip nilai, KHS, dan KRS' },
                    { name: 'Permintaan Konsultasi', icon: 'ðŸ“…', desc: 'Jadwalkan pertemuan dengan dosen wali' },
                    { name: 'Catatan Perwalian', icon: 'ðŸ“', desc: 'Rangkuman hasil diskusi perwalian' },
                    { name: 'Pemberitahuan', icon: 'ðŸ””', desc: 'Notifikasi dari dosen wali dan sistem' },
                ]
            },
            dosen: {
                title: 'Menu Dosen Wali ðŸ‘©â€ðŸ«',
                items: [
                    { name: 'Dashboard Dosen', icon: 'ðŸ“ˆ', desc: 'Statistik mahasiswa bimbingan' },
                    { name: 'Mahasiswa Bimbingan', icon: 'ðŸ‘¥', desc: 'Lihat daftar dan detail mahasiswa' },
                    { name: 'Persetujuan KRS', icon: 'âœ…', desc: 'Validasi Kartu Rencana Studi' },
                    { name: 'Jadwal Konsultasi', icon: 'ðŸ—“ï¸', desc: 'Kelola permintaan konsultasi' },
                    { name: 'Input Catatan Perwalian', icon: 'âœï¸', desc: 'Buat catatan perwalian baru' }
                ]
            },
            admin: {
                title: 'Menu Admin/Tata Usaha ðŸ‘¨â€ðŸ’¼',
                items: [
                    { name: 'Manajemen Pengguna', icon: 'ðŸ‘¤', desc: 'Kelola data mahasiswa dan dosen' },
                    { name: 'Manajemen Data Akademik', icon: 'ðŸ«', desc: 'Kelola mata kuliah dan kurikulum' },
                    { name: 'Jadwal Kuliah', icon: 'ðŸ“…', desc: 'Kelola jadwal perkuliahan' },
                    { name: 'Pengaturan Sistem', icon: 'âš™ï¸', desc: 'Konfigurasi sistem perwalian' },
                ]
            }
        };

        // Sample data
        let userData = [
            { id: 1, nama: 'Ahmad Fauzi', nim: '2023001', email: 'ahmad.fauzi@staimas.ac.id', role: 'Mahasiswa', status: 'Aktif', ipk: 3.85, totalSks: 24, prodi: 'Pendidikan Agama Islam' },
            { id: 2, nama: 'Fatimah Zahra', nim: '2023002', email: 'fatimah.zahra@staimas.ac.id', role: 'Mahasiswa', status: 'Aktif', ipk: 3.90, totalSks: 24, prodi: 'Hukum Ekonomi Syariah (Muamalah)' },
            { id: 3, nama: 'Dr. Siti Nurhaliza', nip: '198501012010012001', email: 'siti.nurhaliza@staimas.ac.id', role: 'Dosen', status: 'Aktif' },
            { id: 4, nama: 'Muhammad Rizki', nim: '2022015', email: 'muhammad.rizki@staimas.ac.id', role: 'Mahasiswa', status: 'Aktif', ipk: 3.75, totalSks: 48, prodi: 'Pendidikan Agama Islam' },
            { id: 5, nama: 'Ustadz Ahmad', nip: '198805102015031002', email: 'ustadz.ahmad@staimas.ac.id', role: 'Dosen', status: 'Aktif' },
            { id: 6, nama: 'Dr. Muhammad Ali', nip: '197903122005011003', email: 'muhammad.ali@staimas.ac.id', role: 'Dosen', status: 'Aktif' },
            { id: 7, nama: 'Annisa Rahmawati', nim: '2023003', email: 'annisa.r@staimas.ac.id', role: 'Mahasiswa', status: 'Aktif', ipk: 3.80, totalSks: 24, prodi: 'Hukum Ekonomi Syariah (Muamalah)' }
        ];

        let academicData = [
            { id: 1, kode: 'PAI101', nama: 'Pengantar Studi Islam', sks: 3, semester: 1, prasyarat: '-', tahunAkademik: '2024/2025 Ganjil' },
            { id: 2, kode: 'ARA101', nama: 'Bahasa Arab Dasar', sks: 2, semester: 1, prasyarat: '-', tahunAkademik: '2024/2025 Ganjil' },
            { id: 3, kode: 'QUR101', nama: 'Ulumul Quran', sks: 3, semester: 1, prasyarat: '-', tahunAkademik: '2024/2025 Ganjil' },
            { id: 4, kode: 'HAD101', nama: 'Ulumul Hadits', sks: 3, semester: 1, prasyarat: '-', tahunAkademik: '2024/2025 Ganjil' },
            { id: 5, kode: 'PAI201', nama: 'Sejarah Peradaban Islam', sks: 3, semester: 2, prasyarat: '-', tahunAkademik: '2023/2024 Genap' }
        ];

        let academicYearData = [
            { id: 1, tahun: '2024/2025', semester: 'Ganjil', status: 'Aktif', fullName: '2024/2025 Ganjil' },
            { id: 2, tahun: '2023/2024', semester: 'Genap', status: 'Nonaktif', fullName: '2023/2024 Genap' }
        ];

        let currentActiveYear = '2024/2025 Ganjil';

        let scheduleData = [
            { id: 1, mataKuliah: 'PAI101', dosen: '198501012010012001', hari: 'Senin', jam: '08:00-10:30', ruang: 'A101' },
            { id: 2, mataKuliah: 'ARA101', dosen: '198805102015031002', hari: 'Selasa', jam: '10:30-12:00', ruang: 'A102' },
            { id: 3, kode: 'QUR101', dosen: '197903122005011003', hari: 'Rabu', jam: '13:00-15:30', ruang: 'A103' }
        ];
        
        // Data for Dosen Wali functionality
        let dosenWaliMap = {
            '198501012010012001': ['2023001', '2023002'], // Dr. Siti Nurhaliza's advisees
            '198805102015031002': ['2022015'],          // Ustadz Ahmad's advisees
        };

        let krsSubmissions = [
            { id: 1, nim: '2023001', courses: ['PAI101', 'ARA101', 'QUR101', 'HAD101'], status: 'Pending', submissionDate: '2024-08-20' },
            { id: 2, nim: '2023002', courses: ['PAI101', 'ARA101'], status: 'Approved', submissionDate: '2024-08-19' },
            { id: 3, nim: '2022015', courses: ['PAI101', 'HAD101'], status: 'Pending', submissionDate: '2024-08-21' }
        ];
        
        let dosenAvailableSlots = [
            { id: 1, dosenNip: '198501012010012001', day: 'Rabu', time: '10:00 - 12:00'},
            { id: 2, dosenNip: '198501012010012001', day: 'Jumat', time: '13:00 - 15:00'},
        ];

        let konsultasiRequests = [
            { id: 1, nim: '2023001', dosenNip: '198501012010012001', proposedDate: '2025-09-10', proposedTime: '14:00', topic: 'Diskusi mata kuliah semester depan', status: 'Approved' },
            { id: 2, nim: '2023002', dosenNip: '198501012010012001', proposedDate: '2025-09-11', proposedTime: '11:00', topic: 'Rencana Cuti', status: 'Pending' }
        ];

        let perwalianNotes = [
            { id: 1, nim: '2023001', dosenNip: '198501012010012001', date: '2024-08-15', note: 'Diskusi mengenai rencana studi semester depan dan pemilihan mata kuliah pilihan. Mahasiswa menunjukkan progres yang baik.', author: 'Dosen' }
        ];
        
        let notifications = [
            { id: 1, recipient: '2023002', type: 'mahasiswa', message: 'KRS Anda telah disetujui oleh Dosen Wali.', date: '2024-08-20', isRead: false },
            { id: 2, recipient: '2023001', type: 'mahasiswa', message: 'Permintaan konsultasi Anda untuk 2025-09-10 14:00 telah disetujui.', date: '2024-08-21', isRead: true },
            { id: 3, recipient: '198501012010012001', type: 'dosen', message: 'Mahasiswa Fatimah Zahra (2023002) mengajukan permintaan konsultasi.', date: '2025-09-04', isRead: false },
        ];
        
        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('customAlert');
            const alertMessage = document.getElementById('customAlertMessage');
            
            alertBox.classList.remove('bg-red-500', 'bg-green-500');
            if (type === 'error') {
                alertBox.classList.add('bg-red-500');
            } else {
                alertBox.classList.add('bg-green-500');
            }

            alertMessage.textContent = message;
            alertBox.classList.remove('hidden', 'translate-x-full');
            alertBox.classList.add('translate-x-0');
            
            setTimeout(() => {
                alertBox.classList.remove('translate-x-0');
                alertBox.classList.add('translate-x-full');
                setTimeout(() => alertBox.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- LOGIN MODALS ---
        function showDosenLoginModal() {
            const activeLecturers = userData.filter(u => u.role === 'Dosen' && u.status === 'Aktif');
            if (activeLecturers.length === 0) {
                showAlert('Tidak ada Dosen Wali yang aktif di sistem.', 'error');
                return;
            }
            let options = activeLecturers.map(dosen => `<option value="${dosen.nip}">${dosen.nama}</option>`).join('');
            createLoginModal('dosenLoginModal', 'Login Dosen Wali', 'Pilih Nama Anda', 'dosenSelect', options, 'loginAsDosen(event)');
            showModal('dosenLoginModal');
        }
        
        function showMahasiswaLoginModal() {
            const activeStudents = userData.filter(u => u.role === 'Mahasiswa' && u.status === 'Aktif');
            if (activeStudents.length === 0) {
                showAlert('Tidak ada mahasiswa aktif di sistem.', 'error');
                return;
            }
            let options = activeStudents.map(mhs => `<option value="${mhs.nim}">${mhs.nama}</option>`).join('');
            createLoginModal('mahasiswaLoginModal', 'Login Mahasiswa', 'Pilih Nama Anda', 'mahasiswaSelect', options, 'loginAsMahasiswa(event)');
            showModal('mahasiswaLoginModal');
        }

        function createLoginModal(id, title, label, selectId, options, onsubmitAction) {
             let modal = document.getElementById(id);
            if (modal) modal.remove();
            modal = document.createElement('div');
            modal.id = id;
            modal.className = 'hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm transform transition-all" role="dialog">
                    <h3 class="text-xl font-bold text-gray-900 mb-6 text-center">${title}</h3>
                    <form onsubmit="${onsubmitAction}">
                        <label for="${selectId}" class="block text-sm font-medium text-gray-700 mb-2">${label}</label>
                        <select id="${selectId}" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white">
                            ${options}
                        </select>
                        <div class="mt-8 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('${id}')" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg">Batal</button>
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">Masuk</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('modalsContainer').appendChild(modal);
        }

        function loginAsDosen(event) {
            event.preventDefault();
            const selectedNip = document.getElementById('dosenSelect').value;
            currentDosen = userData.find(u => u.nip === selectedNip);
            if (currentDosen) {
                selectRole('dosen');
                closeModal('dosenLoginModal');
            }
        }
        
        function loginAsMahasiswa(event) {
            event.preventDefault();
            const selectedNim = document.getElementById('mahasiswaSelect').value;
            currentMahasiswa = userData.find(u => u.nim === selectedNim);
            if(currentMahasiswa) {
                selectRole('mahasiswa');
                closeModal('mahasiswaLoginModal');
            }
        }

        function selectRole(role) {
            currentRole = role;
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            document.getElementById('logoutButton').classList.remove('hidden');

            const roleNames = {
                mahasiswa: currentMahasiswa ? currentMahasiswa.nama : 'Mahasiswa',
                dosen: currentDosen ? currentDosen.nama : 'Dosen Wali',
                admin: 'Admin/Tata Usaha'
            };

            document.getElementById('userName').textContent = roleNames[role];
            loadMenu(role);
            
            if (role === 'dosen') loadDosenDashboard();
            else if (role === 'mahasiswa') loadMahasiswaDashboard();
            else loadContent('Welcome', 'Selamat datang!');
        }

        function loadMenu(role) {
            const menuData_role = menuData[role];
            document.getElementById('menuTitle').textContent = menuData_role.title;

            const menuContainer = document.getElementById('menuContainer');
            menuContainer.innerHTML = '';

            menuData_role.items.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'group bg-gray-50 hover:bg-white rounded-xl p-6 cursor-pointer transition-all duration-200 border border-gray-100 hover:border-blue-200 hover:shadow-card';
                menuItem.onclick = () => loadContent(item.name, item.desc);

                menuItem.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-sm group-hover:scale-105 transition-transform duration-200">
                            <span class="text-2xl">${item.icon}</span>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 text-lg group-hover:text-blue-600 transition-colors">${item.name}</h4>
                            <p class="text-sm text-gray-600 mt-1 leading-relaxed">${item.desc}</p>
                        </div>
                        <div class="text-gray-400 group-hover:text-blue-500 group-hover:translate-x-1 transition-all duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                `;

                menuContainer.appendChild(menuItem);
            });
        }

        function loadContent(menuName, description) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = ''; // Clear previous content

            const contentLoaders = {
                'Manajemen Pengguna': loadUserManagement,
                'Manajemen Data Akademik': loadAcademicDataManagement,
                'Jadwal Kuliah': loadScheduleManagement,
                'Dashboard Dosen': loadDosenDashboard,
                'Mahasiswa Bimbingan': loadMahasiswaBimbingan,
                'Persetujuan KRS': loadPersetujuanKRS,
                'Jadwal Konsultasi': loadJadwalKonsultasi,
                'Input Catatan Perwalian': loadInputCatatanPerwalian,
                'Dashboard': loadMahasiswaDashboard,
                'Profil Akademik': loadProfilAkademik,
                'Permintaan Konsultasi': loadPermintaanKonsultasi,
                'Catatan Perwalian': loadCatatanPerwalianMahasiswa,
                'Pemberitahuan': loadPemberitahuan,
            };

            if (contentLoaders[menuName]) {
                contentLoaders[menuName]();
            } else {
                 contentArea.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl">ðŸš€</span>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">${menuName}</h3>
                        <p class="text-gray-600 mb-6">${description}</p>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto">
                            <p class="text-blue-800 text-sm">
                                <strong>Fitur ini sedang dalam pengembangan.</strong><br>
                                Konten untuk "${menuName}" akan segera tersedia.
                            </p>
                        </div>
                    </div>
                `;
            }
        }
        
        function logout() {
            currentRole = '';
            currentDosen = null;
            currentMahasiswa = null;
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('logoutButton').classList.add('hidden');
            document.getElementById('roleSelection').classList.remove('hidden');
            document.getElementById('userName').textContent = 'Pilih Role Anda';
            document.getElementById('contentArea').innerHTML = `
                <div class="text-center py-16">
                    <div class="w-32 h-32 bg-gradient-to-br from-blue-50 to-blue-100 rounded-3xl flex items-center justify-center mx-auto mb-6">
                        <svg class="w-16 h-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">Selamat Datang di Sistem Perwalian</h3>
                    <p class="text-gray-600 text-lg max-w-md mx-auto">Pilih menu di atas untuk mulai menggunakan sistem perwalian digital</p>
                </div>`;
        }
        
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.querySelector('[role="dialog"]').classList.add('modal-enter');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const dialog = modal.querySelector('[role="dialog"]');
                dialog.classList.remove('modal-enter');
                dialog.classList.add('modal-leave');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    dialog.classList.remove('modal-leave');
                }, 300);
            }
        }

        // ===================================
        // USER MANAGEMENT FUNCTIONS
        // ===================================

        function loadUserManagement() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div>
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900">Manajemen Pengguna</h2>
                            <p class="text-gray-600 mt-1">Kelola data mahasiswa, dosen, dan admin sistem</p>
                        </div>
                        <div>
                            <button onclick="showAddUserModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl flex items-center space-x-2 font-medium shadow-sm hover:shadow-md transition-all duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span>Tambah Pengguna</span>
                            </button>
                        </div>
                    </div>

                    <!-- Search and Filter -->
                    <div class="bg-white rounded-2xl border border-gray-200 p-6 mb-6">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                            <div class="flex-1 max-w-lg">
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    </div>
                                    <input type="text" id="searchUser" placeholder="Cari nama, NIM, atau email..." class="w-full pl-12 pr-12 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50 focus:bg-white transition-colors" oninput="renderUserTable()">
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <select id="filterRole" onchange="renderUserTable()" class="px-4 py-2.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="">Semua Role</option>
                                    <option value="Mahasiswa">Mahasiswa</option>
                                    <option value="Dosen">Dosen</option>
                                </select>
                                <select id="filterStatus" onchange="renderUserTable()" class="px-4 py-2.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="">Semua Status</option>
                                    <option value="Aktif">Aktif</option>
                                    <option value="Nonaktif">Nonaktif</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto shadow-card">
                        <table class="min-w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Pengguna</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">ID/NIM/NIP</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Role</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Status</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>`;
            createAddEditUserModal();
            renderUserTable();
        }
        
        function renderUserTable() {
            const tableBody = document.getElementById('userTableBody');
            if(!tableBody) return;

            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value;
            const statusFilter = document.getElementById('filterStatus').value;

            const filteredUsers = userData.filter(user => {
                const matchesSearch = user.nama.toLowerCase().includes(searchTerm) ||
                                      user.email.toLowerCase().includes(searchTerm) ||
                                      (user.nim && user.nim.includes(searchTerm)) ||
                                      (user.nip && user.nip.includes(searchTerm));
                const matchesRole = roleFilter ? user.role === roleFilter : true;
                const matchesStatus = statusFilter ? user.status === statusFilter : true;

                return matchesSearch && matchesRole && matchesStatus;
            });
            
            if(filteredUsers.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-10">Data tidak ditemukan.</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredUsers.map(user => `
                <tr class="user-row hover:bg-gray-50 transition-colors">
                    <td class="px-8 py-5 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4 flex-shrink-0">
                                <span class="text-white font-semibold text-sm">${user.nama.charAt(0)}</span>
                            </div>
                            <div>
                                <div class="text-sm font-semibold text-gray-900">${user.nama}</div>
                                <div class="text-xs text-gray-500">${user.email}</div>
                                ${user.role === 'Mahasiswa' ? `<div class="text-xs text-blue-700 font-medium">${user.prodi || ''}</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-8 py-5 whitespace-nowrap text-sm text-gray-900">${user.nim || user.nip || user.id}</td>
                    <td class="px-8 py-5 whitespace-nowrap">
                        <span class="inline-flex px-3 py-1.5 text-xs font-semibold rounded-xl ${getRoleBadgeClass(user.role)}">
                            ${user.role}
                        </span>
                    </td>
                    <td class="px-8 py-5 whitespace-nowrap">
                        <span class="inline-flex px-3 py-1.5 text-xs font-semibold rounded-xl ${user.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-8 py-5 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="editUser(${user.id})" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg text-xs font-medium transition-colors">Edit</button>
                            ${user.status === 'Aktif'
                                ? `<button onclick="deactivateUser(${user.id})" class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded-lg text-xs font-medium transition-colors">Nonaktifkan</button>`
                                : `<button onclick="activateUser(${user.id})" class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded-lg text-xs font-medium transition-colors">Aktifkan</button>`
                            }
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function getRoleBadgeClass(role) {
            switch (role) {
                case 'Mahasiswa': return 'bg-blue-100 text-blue-800';
                case 'Dosen': return 'bg-green-100 text-green-800';
                case 'Admin': return 'bg-purple-100 text-purple-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function createAddEditUserModal() {
            let modal = document.createElement('div');
            modal.id = 'userModal';
            modal.className = 'hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md transform transition-all" role="dialog">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="userModalTitle" class="text-2xl font-bold text-gray-900">Tambah Pengguna</h3>
                        <button onclick="closeModal('userModal')" class="text-gray-400 hover:text-gray-600">&times;</button>
                    </div>
                    <form id="userForm" onsubmit="saveUser(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="userNameInput" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                                <input type="text" id="userNameInput" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="userRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                                <select id="userRole" onchange="toggleIdField()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    <option value="Mahasiswa">Mahasiswa</option>
                                    <option value="Dosen">Dosen</option>
                                </select>
                            </div>
                            <div id="prodiField">
                                <label for="userProdi" class="block text-sm font-medium text-gray-700 mb-1">Program Studi</label>
                                <select id="userProdi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    <option value="Pendidikan Agama Islam">Pendidikan Agama Islam</option>
                                    <option value="Hukum Ekonomi Syariah (Muamalah)">Hukum Ekonomi Syariah (Muamalah)</option>
                                </select>
                            </div>
                            <div id="nimField">
                                <label for="userNim" class="block text-sm font-medium text-gray-700 mb-1">NIM</label>
                                <input type="text" id="userNim" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div id="nipField" class="hidden">
                                <label for="userNip" class="block text-sm font-medium text-gray-700 mb-1">NIP</label>
                                <input type="text" id="userNip" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="userEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('userModal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">Batal</button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">Simpan</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('modalsContainer').appendChild(modal);
        }
        
        function toggleIdField() {
            const role = document.getElementById('userRole').value;
            const nimField = document.getElementById('nimField');
            const nipField = document.getElementById('nipField');
            const prodiField = document.getElementById('prodiField');
            const userNimInput = document.getElementById('userNim');
            const userNipInput = document.getElementById('userNip');
            const userProdiInput = document.getElementById('userProdi');
            
            if (role === 'Mahasiswa') {
                nimField.classList.remove('hidden');
                nipField.classList.add('hidden');
                prodiField.classList.remove('hidden');
                userNimInput.required = true;
                userNipInput.required = false;
                userProdiInput.required = true;
            } else {
                nimField.classList.add('hidden');
                nipField.classList.remove('hidden');
                prodiField.classList.add('hidden');
                userNimInput.required = false;
                userNipInput.required = true;
                userProdiInput.required = false;
            }
        }

        function showAddUserModal() {
            currentEditingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Tambah Pengguna Baru';
            document.getElementById('userForm').reset();
            toggleIdField();
            showModal('userModal');
        }

        function editUser(id) {
            const user = userData.find(u => u.id === id);
            if (!user) return;

            currentEditingUserId = id;
            document.getElementById('userModalTitle').textContent = 'Edit Pengguna';
            document.getElementById('userNameInput').value = user.nama;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
            toggleIdField();
            if (user.role === 'Mahasiswa') {
                document.getElementById('userNim').value = user.nim;
                document.getElementById('userProdi').value = user.prodi || 'Pendidikan Agama Islam';
            } else {
                document.getElementById('userNip').value = user.nip;
            }
            showModal('userModal');
        }
        
        function saveUser(event) {
            event.preventDefault();
            const name = document.getElementById('userNameInput').value;
            const email = document.getElementById('userEmail').value;
            const role = document.getElementById('userRole').value;
            const nim = document.getElementById('userNim').value;
            const nip = document.getElementById('userNip').value;
            const prodi = document.getElementById('userProdi').value;

            if (currentEditingUserId) {
                // Editing existing user
                const userIndex = userData.findIndex(u => u.id === currentEditingUserId);
                if (userIndex > -1) {
                    userData[userIndex].nama = name;
                    userData[userIndex].email = email;
                    userData[userIndex].role = role;
                    if(role === 'Mahasiswa') {
                        userData[userIndex].nim = nim;
                        userData[userIndex].prodi = prodi;
                        delete userData[userIndex].nip;
                    } else {
                        userData[userIndex].nip = nip;
                        delete userData[userIndex].nim;
                        delete userData[userIndex].prodi;
                    }
                }
            } else {
                // Adding new user
                const newUser = {
                    id: Math.max(...userData.map(u => u.id), 0) + 1,
                    nama: name,
                    email: email,
                    role: role,
                    status: 'Aktif'
                };
                 if(role === 'Mahasiswa') {
                    newUser.nim = nim;
                    newUser.prodi = prodi;
                    newUser.ipk = 0;
                    newUser.totalSks = 0;
                } else {
                    newUser.nip = nip;
                }
                userData.push(newUser);
            }

            renderUserTable();
            closeModal('userModal');
        }

        function deactivateUser(id) {
            const userIndex = userData.findIndex(u => u.id === id);
            if(userIndex > -1) {
                userData[userIndex].status = 'Nonaktif';
                renderUserTable();
            }
        }
        
        function activateUser(id) {
            const userIndex = userData.findIndex(u => u.id === id);
            if(userIndex > -1) {
                userData[userIndex].status = 'Aktif';
                renderUserTable();
            }
        }
        
        // ===================================
        // ACADEMIC DATA MANAGEMENT FUNCTIONS
        // ===================================
        
        function loadAcademicDataManagement() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                 <div>
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900">Manajemen Data Akademik</h2>
                            <p class="text-gray-600 mt-1">Kelola data mata kuliah dan kurikulum</p>
                        </div>
                        <div class="flex space-x-3">
                             <button onclick="showAcademicYearModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl flex items-center space-x-2 font-medium shadow-sm hover:shadow-md transition-all duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <span>Atur Tahun Akademik</span>
                            </button>
                            <button onclick="showAddCourseModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl flex items-center space-x-2 font-medium shadow-sm hover:shadow-md transition-all duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span>Tambah Mata Kuliah</span>
                            </button>
                        </div>
                    </div>
                    <!-- Active Year Info -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg mb-6" role="alert">
                        <p class="font-bold">Tahun Akademik Aktif: <span id="activeYearDisplay">${currentActiveYear}</span></p>
                        <p class="text-sm">Mata kuliah yang ditampilkan di bawah ini adalah untuk tahun akademik yang sedang aktif.</p>
                    </div>
                    <!-- Academic Data Table -->
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto shadow-card">
                        <table class="min-w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Kode MK</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Nama Mata Kuliah</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">SKS</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Semester</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="academicTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            `;
            createAddEditCourseModal();
            renderAcademicTable();
        }

        function renderAcademicTable() {
            const tableBody = document.getElementById('academicTableBody');
            if(!tableBody) return;

            const coursesForActiveYear = academicData.filter(course => course.tahunAkademik === currentActiveYear);

            if(coursesForActiveYear.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-10">Belum ada mata kuliah untuk tahun akademik ${currentActiveYear}.</td></tr>`;
                return;
            }
            
            tableBody.innerHTML = coursesForActiveYear.map(course => `
                 <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-8 py-5 whitespace-nowrap font-mono text-sm text-gray-700">${course.kode}</td>
                    <td class="px-8 py-5 whitespace-nowrap font-semibold text-sm text-gray-900">${course.nama}</td>
                    <td class="px-8 py-5 whitespace-nowrap text-sm text-gray-700">${course.sks}</td>
                    <td class="px-8 py-5 whitespace-nowrap text-sm text-gray-700">${course.semester}</td>
                    <td class="px-8 py-5 whitespace-nowrap text-sm font-medium">
                        <button onclick="editCourse(${course.id})" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg text-xs font-medium transition-colors">Edit</button>
                    </td>
                </tr>
            `).join('');
        }

        function createAddEditCourseModal() {
             let modal = document.createElement('div');
            modal.id = 'courseModal';
            modal.className = 'hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md transform transition-all" role="dialog">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="courseModalTitle" class="text-2xl font-bold text-gray-900">Tambah Mata Kuliah</h3>
                        <button onclick="closeModal('courseModal')" class="text-gray-400 hover:text-gray-600">&times;</button>
                    </div>
                    <form id="courseForm" onsubmit="saveCourse(event)">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="courseCode" class="block text-sm font-medium text-gray-700 mb-1">Kode MK</label>
                                <input type="text" id="courseCode" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="col-span-2">
                                <label for="courseName" class="block text-sm font-medium text-gray-700 mb-1">Nama Mata Kuliah</label>
                                <input type="text" id="courseName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="courseSks" class="block text-sm font-medium text-gray-700 mb-1">SKS</label>
                                <input type="number" id="courseSks" min="1" max="6" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="courseSemester" class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <input type="number" id="courseSemester" min="1" max="8" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('courseModal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">Batal</button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">Simpan</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('modalsContainer').appendChild(modal);
        }
        
        function showAddCourseModal() {
            currentEditingCourseId = null;
            document.getElementById('courseModalTitle').textContent = 'Tambah Mata Kuliah';
            document.getElementById('courseForm').reset();
            showModal('courseModal');
        }

        function editCourse(id) {
            const course = academicData.find(c => c.id === id);
            if (!course) return;

            currentEditingCourseId = id;
            document.getElementById('courseModalTitle').textContent = 'Edit Mata Kuliah';
            document.getElementById('courseCode').value = course.kode;
            document.getElementById('courseName').value = course.nama;
            document.getElementById('courseSks').value = course.sks;
            document.getElementById('courseSemester').value = course.semester;
            showModal('courseModal');
        }

        function saveCourse(event) {
            event.preventDefault();
            const kode = document.getElementById('courseCode').value;
            const nama = document.getElementById('courseName').value;
            const sks = document.getElementById('courseSks').value;
            const semester = document.getElementById('courseSemester').value;

            if (currentEditingCourseId) {
                const courseIndex = academicData.findIndex(c => c.id === currentEditingCourseId);
                if (courseIndex > -1) {
                    academicData[courseIndex] = { ...academicData[courseIndex], kode, nama, sks, semester };
                }
            } else {
                const newCourse = {
                    id: Math.max(...academicData.map(c => c.id), 0) + 1,
                    kode, nama, sks, semester,
                    prasyarat: '-', 
                    tahunAkademik: currentActiveYear
                };
                academicData.push(newCourse);
            }
            renderAcademicTable();
            closeModal('courseModal');
        }

        // ===================================
        // ACADEMIC YEAR FUNCTIONS
        // ===================================
        
        function createAcademicYearModal() {
            let modal = document.createElement('div');
            modal.id = 'academicYearModal';
            modal.className = 'hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-2xl transform transition-all" role="dialog">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">Atur Tahun Akademik</h3>
                        <button onclick="closeModal('academicYearModal')" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Left side: Add new year -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Tambah Tahun Akademik Baru</h4>
                            <form id="addYearForm" onsubmit="addAcademicYear(event)" class="space-y-4">
                                <div>
                                    <label for="newYear" class="block text-sm font-medium text-gray-700 mb-1">Tahun (e.g., 2024/2025)</label>
                                    <input type="text" id="newYear" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="newSemester" class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                    <select id="newSemester" required class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                        <option value="Ganjil">Ganjil</option>
                                        <option value="Genap">Genap</option>
                                    </select>
                                </div>
                                <div class="pt-2">
                                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">Tambah</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Right side: List of years -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Daftar Tahun Akademik</h4>
                            <div id="academicYearList" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                                <!-- List will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalsContainer').appendChild(modal);
        }

        function showAcademicYearModal() {
            if (!document.getElementById('academicYearModal')) {
                createAcademicYearModal();
            }
            renderAcademicYearList();
            showModal('academicYearModal');
        }

        function renderAcademicYearList() {
            const listContainer = document.getElementById('academicYearList');
            if (!listContainer) return;

            listContainer.innerHTML = academicYearData
                .sort((a, b) => b.tahun.localeCompare(a.tahun) || b.semester.localeCompare(a.semester))
                .map(year => `
                <div class="flex items-center justify-between p-3 rounded-lg ${year.status === 'Aktif' ? 'bg-green-100' : 'bg-gray-50'}">
                    <div>
                        <p class="font-semibold text-gray-800">${year.fullName}</p>
                        <p class="text-xs ${year.status === 'Aktif' ? 'text-green-700' : 'text-gray-500'}">${year.status}</p>
                    </div>
                    <div>
                        ${year.status !== 'Aktif' ?
                            `<button onclick="setActiveAcademicYear(${year.id})" class="bg-white hover:bg-gray-100 text-gray-700 px-3 py-1 rounded-md text-xs font-medium transition-colors border">Jadikan Aktif</button>` :
                            `<span class="text-green-600 font-bold text-xs">âœ“ Aktif</span>`
                        }
                    </div>
                </div>
            `).join('');
        }

        function addAcademicYear(event) {
            event.preventDefault();
            const yearInput = document.getElementById('newYear');
            const semesterInput = document.getElementById('newSemester');
            const newFullName = `${yearInput.value} ${semesterInput.value}`;

            // Check for duplicates
            if (academicYearData.some(y => y.fullName === newFullName)) {
                showAlert('Tahun akademik tersebut sudah ada.', 'error');
                return;
            }

            const newYear = {
                id: Math.max(...academicYearData.map(y => y.id), 0) + 1,
                tahun: yearInput.value,
                semester: semesterInput.value,
                status: 'Nonaktif',
                fullName: newFullName
            };
            academicYearData.push(newYear);
            document.getElementById('addYearForm').reset();
            renderAcademicYearList();
        }

        function setActiveAcademicYear(id) {
            let newActiveYearFullName = '';
            academicYearData.forEach(year => {
                if (year.id === id) {
                    year.status = 'Aktif';
                    newActiveYearFullName = year.fullName;
                } else {
                    year.status = 'Nonaktif';
                }
            });

            currentActiveYear = newActiveYearFullName;
            
            // Update UI elements
            const activeYearDisplay = document.getElementById('activeYearDisplay');
            if (activeYearDisplay) {
                activeYearDisplay.textContent = currentActiveYear;
            }
            
            renderAcademicYearList();
            renderAcademicTable(); // This is crucial to update the course list
        }
        
         // ===================================
        // SCHEDULE MANAGEMENT FUNCTIONS
        // ===================================

        function loadScheduleManagement() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                 <div>
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900">Manajemen Jadwal Kuliah</h2>
                            <p class="text-gray-600 mt-1">Kelola jadwal perkuliahan untuk tahun ajaran aktif</p>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="printSchedule()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl flex items-center space-x-2 font-medium shadow-sm hover:shadow-md transition-all duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                <span>Cetak Jadwal</span>
                            </button>
                            <button onclick="showAddScheduleModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl flex items-center space-x-2 font-medium shadow-sm hover:shadow-md transition-all duration-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span>Tambah Jadwal</span>
                            </button>
                        </div>
                    </div>
                    <!-- Schedule Table -->
                    <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto shadow-card">
                        <table class="min-w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Mata Kuliah</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Dosen</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Hari & Jam</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Ruang</th>
                                    <th class="px-8 py-4 text-left text-sm font-semibold text-gray-900">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody" class="bg-white divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            `;
            createAddEditScheduleModal();
            renderScheduleTable();
        }
        
        function renderScheduleTable() {
            const tableBody = document.getElementById('scheduleTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = scheduleData.map(schedule => {
                const course = academicData.find(c => c.kode === schedule.mataKuliah);
                const lecturer = userData.find(u => u.nip === schedule.dosen);
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-8 py-5 whitespace-nowrap">
                            <div class="font-semibold text-sm text-gray-900">${course ? course.nama : 'N/A'}</div>
                            <div class="text-xs text-gray-500 font-mono">${schedule.mataKuliah}</div>
                        </td>
                        <td class="px-8 py-5 whitespace-nowrap text-sm text-gray-700">${lecturer ? lecturer.nama : 'N/A'}</td>
                        <td class="px-8 py-5 whitespace-nowrap">
                             <div class="font-semibold text-sm text-gray-900">${schedule.hari}</div>
                            <div class="text-xs text-gray-500">${schedule.jam}</div>
                        </td>
                        <td class="px-8 py-5 whitespace-nowrap text-sm text-gray-700">${schedule.ruang}</td>
                        <td class="px-8 py-5 whitespace-nowrap text-sm font-medium">
                            <button onclick="editSchedule(${schedule.id})" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg text-xs font-medium transition-colors">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function createAddEditScheduleModal() {
            const coursesOptions = academicData.map(c => `<option value="${c.kode}">${c.kode} - ${c.nama}</option>`).join('');
            const lecturersOptions = userData.filter(u => u.role === 'Dosen').map(d => `<option value="${d.nip}">${d.nama}</option>`).join('');
            const daysOptions = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'].map(day => `<option value="${day}">${day}</option>`).join('');

            let modal = document.createElement('div');
            modal.id = 'scheduleModal';
            modal.className = 'hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg transform transition-all" role="dialog">
                     <div class="flex justify-between items-center mb-6">
                        <h3 id="scheduleModalTitle" class="text-2xl font-bold text-gray-900">Tambah Jadwal</h3>
                        <button onclick="closeModal('scheduleModal')" class="text-gray-400 hover:text-gray-600">&times;</button>
                    </div>
                    <form id="scheduleForm" onsubmit="saveSchedule(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="scheduleCourse" class="block text-sm font-medium text-gray-700 mb-1">Mata Kuliah</label>
                                <select id="scheduleCourse" required class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">${coursesOptions}</select>
                            </div>
                            <div>
                                <label for="scheduleLecturer" class="block text-sm font-medium text-gray-700 mb-1">Dosen Pengampu</label>
                                <select id="scheduleLecturer" required class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">${lecturersOptions}</select>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label for="scheduleDay" class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
                                    <select id="scheduleDay" required class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">${daysOptions}</select>
                                </div>
                                <div>
                                    <label for="scheduleTime" class="block text-sm font-medium text-gray-700 mb-1">Jam (e.g. 08:00-10:30)</label>
                                    <input type="text" id="scheduleTime" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="scheduleRoom" class="block text-sm font-medium text-gray-700 mb-1">Ruang</label>
                                    <input type="text" id="scheduleRoom" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('scheduleModal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">Batal</button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">Simpan</button>
                        </div>
                    </form>
                </div>
            `;
             document.getElementById('modalsContainer').appendChild(modal);
        }

        function showAddScheduleModal() {
            currentEditingScheduleId = null;
            document.getElementById('scheduleModalTitle').textContent = 'Tambah Jadwal Kuliah';
            document.getElementById('scheduleForm').reset();
            showModal('scheduleModal');
        }

        function editSchedule(id) {
            const schedule = scheduleData.find(s => s.id === id);
            if (!schedule) return;
            
            currentEditingScheduleId = id;
            document.getElementById('scheduleModalTitle').textContent = 'Edit Jadwal Kuliah';
            document.getElementById('scheduleCourse').value = schedule.mataKuliah;
            document.getElementById('scheduleLecturer').value = schedule.dosen;
            document.getElementById('scheduleDay').value = schedule.hari;
            document.getElementById('scheduleTime').value = schedule.jam;
            document.getElementById('scheduleRoom').value = schedule.ruang;
            showModal('scheduleModal');
        }

        function saveSchedule(event) {
            event.preventDefault();
            const mataKuliah = document.getElementById('scheduleCourse').value;
            const dosen = document.getElementById('scheduleLecturer').value;
            const hari = document.getElementById('scheduleDay').value;
            const jam = document.getElementById('scheduleTime').value;
            const ruang = document.getElementById('scheduleRoom').value;

            if (currentEditingScheduleId) {
                const scheduleIndex = scheduleData.findIndex(s => s.id === currentEditingScheduleId);
                if (scheduleIndex > -1) {
                    scheduleData[scheduleIndex] = { ...scheduleData[scheduleIndex], mataKuliah, dosen, hari, jam, ruang };
                }
            } else {
                const newSchedule = {
                    id: Math.max(...scheduleData.map(s => s.id), 0) + 1,
                    mataKuliah, dosen, hari, jam, ruang
                };
                scheduleData.push(newSchedule);
            }
            renderScheduleTable();
            closeModal('scheduleModal');
        }

        function printSchedule() {
            const printWindow = window.open('', '_blank');
            const tableContent = scheduleData.map(schedule => {
                const course = academicData.find(c => c.kode === schedule.mataKuliah);
                const lecturer = userData.find(u => u.nip === schedule.dosen);
                return `
                    <tr>
                        <td style="border: 1px solid black; padding: 8px;">${schedule.mataKuliah}</td>
                        <td style="border: 1px solid black; padding: 8px;">${course ? course.nama : 'N/A'}</td>
                        <td style="border: 1px solid black; padding: 8px;">${lecturer ? lecturer.nama : 'N/A'}</td>
                        <td style="border: 1px solid black; padding: 8px;">${schedule.hari}</td>
                        <td style="border: 1px solid black; padding: 8px;">${schedule.jam}</td>
                        <td style="border: 1px solid black; padding: 8px;">${schedule.ruang}</td>
                    </tr>
                `;
            }).join('');

            const printHtml = `
                <html>
                    <head>
                        <title>Cetak Jadwal Kuliah</title>
                        <style>
                            body { font-family: 'Times New Roman', Times, serif; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid black; padding: 8px; text-align: left; font-size: 12px; }
                            th { background-color: #f2f2f2; }
                            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid black; padding-bottom: 10px;}
                            h1 { margin: 0; font-size: 18px; }
                            h2 { margin: 0; font-size: 16px; }
                            h3 { margin: 5px 0 0 0; font-size: 14px; font-weight: normal; }
                            @media print {
                                @page {
                                    size: A4;
                                    margin: 20mm;
                                }
                                body {
                                    -webkit-print-color-adjust: exact;
                                    print-color-adjust: exact;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>JADWAL PERKULIAHAN</h1>
                            <h2>STAI AL-MAS'UDIYAH SUKABUMI</h2>
                            <h3>Tahun Akademik: ${currentActiveYear}</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="border: 1px solid black; padding: 8px;">Kode MK</th>
                                    <th style="border: 1px solid black; padding: 8px;">Mata Kuliah</th>
                                    <th style="border: 1px solid black; padding: 8px;">Dosen</th>
                                    <th style="border: 1px solid black; padding: 8px;">Hari</th>
                                    <th style="border: 1px solid black; padding: 8px;">Jam</th>
                                    <th style="border: 1px solid black; padding: 8px;">Ruang</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableContent}
                            </tbody>
                        </table>
                    </body>
                </html>
            `;

            printWindow.document.write(printHtml);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // ===================================
        // DOSEN WALI FUNCTIONS
        // ===================================

        function loadDosenDashboard() {
            if (!currentDosen) return;
            const adviseeNims = dosenWaliMap[currentDosen.nip] || [];
            const pendingKrsCount = krsSubmissions.filter(k => adviseeNims.includes(k.nim) && k.status === 'Pending').length;
            const pendingConsultations = konsultasiRequests.filter(r => r.dosenNip === currentDosen.nip && r.status === 'Pending').length;
            const unreadNotifs = notifications.filter(n => n.recipient === currentDosen.nip && n.type === 'dosen' && !n.isRead).length;

            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Dashboard Dosen Wali</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-blue-50 border border-blue-200 p-6 rounded-2xl">
                            <h3 class="text-lg font-semibold text-blue-900">Total Mahasiswa Bimbingan</h3>
                            <p class="text-4xl font-bold text-blue-600 mt-2">${adviseeNims.length}</p>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 p-6 rounded-2xl">
                            <h3 class="text-lg font-semibold text-yellow-900">Persetujuan KRS Pending</h3>
                            <p class="text-4xl font-bold text-yellow-600 mt-2">${pendingKrsCount}</p>
                        </div>
                        <div class="bg-green-50 border border-green-200 p-6 rounded-2xl">
                            <h3 class="text-lg font-semibold text-green-900">Permintaan Konsultasi</h3>
                            <p class="text-4xl font-bold text-green-600 mt-2">${pendingConsultations}</p>
                        </div>
                    </div>
                    <div class="mt-8">
                         <h3 class="text-xl font-bold text-gray-800 mb-4">Pemberitahuan Terbaru (${unreadNotifs})</h3>
                         <div id="dosen-dashboard-notifications" class="space-y-3"></div>
                    </div>
                </div>
            `;
            
            const notifContainer = document.getElementById('dosen-dashboard-notifications');
            const myNotifications = notifications.filter(n => n.recipient === currentDosen.nip && n.type === 'dosen').slice(0, 4);

            if (myNotifications.length > 0) {
                 notifContainer.innerHTML += myNotifications.map(n => `<div class="text-sm p-3 bg-gray-50 rounded-md">${n.message}</div>`).join('');
            } else {
                 notifContainer.innerHTML += `<p class="text-sm text-gray-500">Tidak ada pemberitahuan baru.</p>`;
            }
             myNotifications.forEach(n => n.isRead = true);

        }

        function loadMahasiswaBimbingan() {
             if (!currentDosen) return;
            const contentArea = document.getElementById('contentArea');
            const adviseeNims = dosenWaliMap[currentDosen.nip] || [];
            const advisees = userData.filter(user => adviseeNims.includes(user.nim));

            let tableRows = advisees.map(mhs => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${mhs.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${mhs.nim}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${mhs.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="removeAdvisee('${mhs.nim}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                </tr>
            `).join('');

            if (advisees.length === 0) {
                tableRows = `<tr><td colspan="4" class="text-center text-gray-500 py-10">Anda belum memiliki mahasiswa bimbingan.</td></tr>`;
            }

            contentArea.innerHTML = `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Mahasiswa Bimbingan</h2>
                        <button onclick="showAddAdviseeModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg flex items-center space-x-2 font-medium">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span>Tambah Bimbingan</span>
                        </button>
                    </div>
                    <div class="bg-white rounded-2xl border overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIM</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Hapus</span></th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        }
        
        function showAddAdviseeModal() {
            // Find students who are not yet assigned to any lecturer
            const allAdviseeNims = Object.values(dosenWaliMap).flat();
            const unassignedStudents = userData.filter(u => u.role === 'Mahasiswa' && !allAdviseeNims.includes(u.nim));
            
            let options = unassignedStudents.map(s => `<option value="${s.nim}">${s.nim} - ${s.nama}</option>`).join('');
            if (unassignedStudents.length === 0) {
                options = `<option disabled>Semua mahasiswa sudah memiliki dosen wali.</option>`;
            }

            let modal = document.getElementById('addAdviseeModal');
            if (modal) modal.remove(); // Remove old modal if exists

            modal = document.createElement('div');
            modal.id = 'addAdviseeModal';
            modal.className = 'hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md transform transition-all" role="dialog">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Tambah Mahasiswa Bimbingan</h3>
                    <form onsubmit="addAdvisee(event)">
                        <label for="studentSelect" class="block text-sm font-medium text-gray-700 mb-2">Pilih Mahasiswa</label>
                        <select id="studentSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" ${unassignedStudents.length === 0 ? 'disabled' : ''}>
                            ${options}
                        </select>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('addAdviseeModal')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg">Batal</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg" ${unassignedStudents.length === 0 ? 'disabled' : ''}>Tambah</button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('modalsContainer').appendChild(modal);
            showModal('addAdviseeModal');
        }

        function addAdvisee(event) {
            event.preventDefault();
            const nim = document.getElementById('studentSelect').value;
            if (nim && currentDosen) {
                if (!dosenWaliMap[currentDosen.nip]) {
                    dosenWaliMap[currentDosen.nip] = [];
                }
                dosenWaliMap[currentDosen.nip].push(nim);
                loadMahasiswaBimbingan();
                closeModal('addAdviseeModal');
                showAlert('Mahasiswa bimbingan berhasil ditambahkan.');
            }
        }
        
        function removeAdvisee(nim) {
            if (confirm(`Apakah Anda yakin ingin menghapus mahasiswa dengan NIM ${nim} dari daftar bimbingan Anda?`)) {
                const adviseeList = dosenWaliMap[currentDosen.nip];
                const index = adviseeList.indexOf(nim);
                if (index > -1) {
                    adviseeList.splice(index, 1);
                    loadMahasiswaBimbingan();
                    showAlert('Mahasiswa bimbingan berhasil dihapus.');
                }
            }
        }


        function loadPersetujuanKRS() {
            if (!currentDosen) return;
            const contentArea = document.getElementById('contentArea');
            const adviseeNims = dosenWaliMap[currentDosen.nip] || [];
            const submissions = krsSubmissions.filter(s => adviseeNims.includes(s.nim));
            
            let submissionCards = submissions.map(sub => {
                const student = userData.find(u => u.nim === sub.nim);
                const statusColors = {
                    Pending: { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-400'},
                    Approved: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-400'},
                    Rejected: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-400'}
                };
                const color = statusColors[sub.status];

                return `
                <div class="border ${color.border} ${color.bg} p-4 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">${student.nama} (${student.nim})</p>
                            <p class="text-sm text-gray-600">Total SKS: ${sub.courses.reduce((acc, code) => acc + (academicData.find(c => c.kode === code)?.sks || 0), 0)}</p>
                            <p class="text-xs text-gray-500">Tanggal Pengajuan: ${sub.submissionDate}</p>
                        </div>
                        <span class="text-xs font-bold ${color.text} px-2 py-1 rounded-full ${color.bg}">${sub.status}</span>
                    </div>
                    <div class="mt-4">
                        <ul class="text-sm list-disc list-inside text-gray-700">
                            ${sub.courses.map(c => `<li>${c} - ${academicData.find(ad => ad.kode === c)?.nama || ''}</li>`).join('')}
                        </ul>
                    </div>
                    ${sub.status === 'Pending' ? `
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="updateKrsStatus(${sub.id}, 'Rejected')" class="text-sm bg-red-500 text-white px-3 py-1 rounded-md">Tolak</button>
                        <button onclick="updateKrsStatus(${sub.id}, 'Approved')" class="text-sm bg-green-500 text-white px-3 py-1 rounded-md">Setujui</button>
                    </div>` : ''}
                </div>
                `;
            }).join('');
            
            if (submissions.length === 0) {
                 submissionCards = `<div class="text-center text-gray-500 py-10">Tidak ada pengajuan KRS dari mahasiswa bimbingan Anda.</div>`;
            }

            contentArea.innerHTML = `
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Persetujuan KRS</h2>
                    <div class="space-y-4">${submissionCards}</div>
                </div>
            `;
        }
        
        function updateKrsStatus(submissionId, newStatus) {
            const submission = krsSubmissions.find(s => s.id === submissionId);
            if(submission) {
                submission.status = newStatus;
                loadPersetujuanKRS();
                showAlert(`KRS berhasil di-${newStatus === 'Approved' ? 'setujui' : 'tolak'}.`);
            }
        }


        function loadJadwalKonsultasi() {
            if (!currentDosen) return;
            const contentArea = document.getElementById('contentArea');
            const myRequests = konsultasiRequests.filter(r => r.dosenNip === currentDosen.nip);

            let requestsHtml = myRequests.map(req => {
                const student = userData.find(u => u.nim === req.nim);
                const statusColors = {
                    Pending: { bg: 'bg-yellow-100', border: 'border-yellow-400' },
                    Approved: { bg: 'bg-green-100', border: 'border-green-400' },
                    Rejected: { bg: 'bg-red-100', border: 'border-red-400' }
                };
                return `
                    <div class="p-4 rounded-lg border ${statusColors[req.status].bg} ${statusColors[req.status].border}">
                        <p><strong>${student.nama}</strong> (${student.nim})</p>
                        <p class="text-sm">Mengajukan jadwal: <strong>${req.proposedDate}</strong> pukul <strong>${req.proposedTime}</strong></p>
                        <p class="text-sm my-2 p-2 bg-white rounded"><em>Topik: ${req.topic}</em></p>
                        ${req.status === 'Pending' ?
                        `<div class="flex justify-end space-x-2 mt-2">
                            <button onclick="handleConsultationRequest(${req.id}, 'Rejected')" class="text-xs bg-red-500 text-white px-3 py-1 rounded">Tolak</button>
                            <button onclick="handleConsultationRequest(${req.id}, 'Approved')" class="text-xs bg-green-500 text-white px-3 py-1 rounded">Setujui</button>
                         </div>` :
                        `<p class="text-right text-sm font-bold">${req.status}</p>`
                        }
                    </div>
                `
            }).join('');
            
            if (myRequests.length === 0) {
                requestsHtml = '<p class="text-center text-gray-500 py-10">Belum ada permintaan konsultasi.</p>';
            }

            contentArea.innerHTML = `
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Manajemen Konsultasi</h2>
                    <div class="space-y-4">
                        ${requestsHtml}
                    </div>
                </div>
            `;
        }
        
        function handleConsultationRequest(requestId, status) {
            const request = konsultasiRequests.find(r => r.id === requestId);
            if (request) {
                request.status = status;
                
                // Create notification for student
                const newNotif = {
                    id: Math.max(...notifications.map(n => n.id), 0) + 1,
                    recipient: request.nim,
                    type: 'mahasiswa',
                    message: `Permintaan konsultasi Anda untuk ${request.proposedDate} pukul ${request.proposedTime} telah di${status === 'Approved' ? 'setujui' : 'tolak'}.`,
                    date: new Date().toISOString().split('T')[0],
                    isRead: false
                };
                notifications.push(newNotif);

                showAlert(`Permintaan berhasil di${status === 'Approved' ? 'setujui' : 'tolak'}.`);
                loadJadwalKonsultasi();
            }
        }


        function loadInputCatatanPerwalian() {
             if (!currentDosen) return;
            const contentArea = document.getElementById('contentArea');
            const adviseeNims = dosenWaliMap[currentDosen.nip] || [];
            const advisees = userData.filter(user => adviseeNims.includes(user.nim));
            
            const studentOptions = advisees.map(s => `<option value="${s.nim}">${s.nim} - ${s.nama}</option>`).join('');
            
            contentArea.innerHTML = `
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Input Catatan Perwalian</h2>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            <form onsubmit="savePerwalianNote(event)" class="bg-white border p-4 rounded-lg space-y-4">
                                <h3 class="font-semibold">Buat Catatan Baru</h3>
                                <div>
                                    <label for="noteStudent" class="text-sm font-medium">Mahasiswa</label>
                                    <select id="noteStudent" class="w-full mt-1 border-gray-300 rounded-md">${studentOptions}</select>
                                </div>
                                 <div>
                                    <label for="noteDate" class="text-sm font-medium">Tanggal</label>
                                    <input type="date" id="noteDate" value="${new Date().toISOString().substr(0, 10)}" required class="w-full mt-1 border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="noteContent" class="text-sm font-medium">Isi Catatan</label>
                                    <textarea id="noteContent" rows="5" required class="w-full mt-1 border-gray-300 rounded-md"></textarea>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md">Simpan Catatan</button>
                            </form>
                        </div>
                        <div id="notesHistoryContainer" class="md:col-span-2">
                             <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold">Riwayat Catatan</h3>
                                <button id="printNotesButton" onclick="printCatatanPerwalian()" class="bg-gray-200 text-gray-800 px-4 py-1.5 rounded-lg text-sm font-medium" disabled>
                                    Cetak Catatan
                                </button>
                             </div>
                             <div id="notesHistoryContent">
                                <p class="text-center text-gray-500 p-8 bg-gray-50 rounded-lg">Pilih mahasiswa untuk melihat riwayat catatannya.</p>
                             </div>
                        </div>
                     </div>
                </div>`;
            
            document.getElementById('noteStudent').addEventListener('change', (e) => renderNotesHistory(e.target.value));
        }

function savePerwalianNote(event) {
    event.preventDefault(); // Mencegah halaman refresh saat tombol diklik

    // Mengambil data dari input form
    const nim = document.getElementById('noteStudent').value;
    const date = document.getElementById('noteDate').value;
    const note = document.getElementById('noteContent').value.trim();

    if (!nim || !note || !date) {
        showAlert('Semua field harus diisi.', 'error');
        return;
    }
    
    // Mencari data lengkap mahasiswa berdasarkan NIM
    const mahasiswa = userData.find(m => m.nim === nim);

    // 1. Kumpulkan data dalam format yang rapi untuk dikirim ke Google Sheet
    const dataUntukSheet = {
        namaDosen: currentDosen.nama,
        nipDosen: currentDosen.nip,
        namaMahasiswa: mahasiswa ? mahasiswa.nama : 'N/A', // Cek jika mahasiswa ada
        nimMahasiswa: nim,
        tanggalCatatan: date,
        isiCatatan: note
    };

    // 2. Panggil fungsi yang mengirim data ke Google Sheet
    kirimCatatanKeSheet(dataUntukSheet);

    // 3. Lanjutkan sisa logika aplikasi Anda (menyimpan ke array lokal, dll.)
    const newNote = {
        id: perwalianNotes.length + 1,
        nim: nim,
        dosenNip: currentDosen.nip,
        date: date,
        note: note,
        author: 'Dosen'
    };

    perwalianNotes.push(newNote);
    showAlert('Catatan perwalian berhasil ditambahkan.');
    
    // Muat ulang tampilan riwayat catatan untuk mahasiswa yang dipilih
    renderNotesHistory(nim); 
}
        function renderNotesHistory(nim) {
            const container = document.getElementById('notesHistoryContent');
            const printButton = document.getElementById('printNotesButton');
            if (!container || !printButton) return;
            
            const student = userData.find(u=>u.nim === nim);
            
            const notes = perwalianNotes
                .filter(n => n.nim === nim)
                .sort((a,b) => new Date(b.date) - new Date(a.date));
                
            let historyHtml = ``;

            if (notes.length === 0) {
                 historyHtml += `<p class="text-center text-gray-500 p-8 bg-gray-50 rounded-lg">Belum ada catatan untuk mahasiswa ini.</p>`;
                 printButton.disabled = true;
            } else {
                historyHtml += `<div class="space-y-3">` + notes.map(note => `
                    <div class="bg-white border p-3 rounded-lg">
                        <p class="text-xs font-bold text-gray-500">${note.date}</p>
                        <p class="text-sm mt-1">${note.note}</p>
                    </div>
                `).join('') + `</div>`;
                 printButton.disabled = false;
            }
            container.innerHTML = historyHtml;
        }

        async function savePerwalianNote(event) {
            event.preventDefault();
            const nim = document.getElementById('noteStudent').value;
            const student = userData.find(u => u.nim === nim);
            const date = document.getElementById('noteDate').value;
            const note = document.getElementById('noteContent').value;
            
            if (!nim) {
                showAlert('Silakan pilih mahasiswa terlebih dahulu.', 'error');
                return;
            }

            const newNote = {
                id: Math.max(...perwalianNotes.map(n => n.id), 0) + 1,
                nim,
                dosenNip: currentDosen.nip,
                date,
                note,
                author: 'Dosen'
            };
            perwalianNotes.push(newNote);

            // Sync with Google Sheets if URL is provided
            if (SPREADSHEET_URL) {
                const formData = new FormData();
                formData.append('timestamp', new Date().toLocaleString('id-ID'));
                formData.append('dosenWali', currentDosen.nama);
                formData.append('nim', nim);
                formData.append('namaMahasiswa', student.nama);
                formData.append('tanggalCatatan', date);
                formData.append('isiCatatan', note);
                
                try {
                    await fetch(SPREADSHEET_URL, {
                        method: 'POST',
                        body: formData,
                    });
                    showAlert('Catatan perwalian berhasil disimpan dan disinkronkan ke Spreadsheet.');
                } catch (error) {
                    console.error('Error syncing to Google Sheets:', error);
                    showAlert('Catatan disimpan lokal, tapi gagal sinkronisasi ke Spreadsheet.', 'error');
                }
            } else {
                 showAlert('Catatan perwalian berhasil disimpan.');
            }
            
            event.target.reset();
            renderNotesHistory(nim);
        }

        function printCatatanPerwalian() {
            const nim = document.getElementById('noteStudent').value;
            if (!nim) return;

            const student = userData.find(u => u.nim === nim);
            const notes = perwalianNotes.filter(n => n.nim === nim).sort((a,b) => new Date(a.date) - new Date(b.date));

            const printWindow = window.open('', '_blank');
            const notesHtml = notes.map(note => `
                <tr>
                    <td style="border: 1px solid black; padding: 8px;">${note.date}</td>
                    <td style="border: 1px solid black; padding: 8px;">${note.note}</td>
                    <td style="border: 1px solid black; padding: 8px;">${note.author}</td>
                </tr>
            `).join('');

            const printPageHtml = `
                <html>
                    <head><title>Cetak Catatan Perwalian - ${student.nama}</title>
                    <style>
                        body { font-family: 'Times New Roman', Times, serif; }
                        .header { text-align: center; margin-bottom: 20px; }
                        h1, h2, p { margin: 5px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid black; padding: 8px; text-align: left; font-size: 12px; }
                    </style>
                    </head>
                    <body>
                        <div class="header">
                            <h2>CATATAN PERWALIAN MAHASISWA</h2>
                        </div>
                        <p><strong>Nama Mahasiswa:</strong> ${student.nama}</p>
                        <p><strong>NIM:</strong> ${student.nim}</p>
                        <p><strong>Dosen Wali:</strong> ${currentDosen.nama}</p>
                        <table>
                            <thead>
                                <tr><th>Tanggal</th><th>Isi Catatan</th><th>Pembuat Catatan</th></tr>
                            </thead>
                            <tbody>${notesHtml}</tbody>
                        </table>
                    </body>
                </html>`;
            
            printWindow.document.write(printPageHtml);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // ===================================
        // MAHASISWA FUNCTIONS
        // ===================================
        
        function loadMahasiswaDashboard() {
            if (!currentMahasiswa) return;
            const contentArea = document.getElementById('contentArea');
            const krs = krsSubmissions.find(k => k.nim === currentMahasiswa.nim);
            const unreadNotifs = notifications.filter(n => n.recipient === currentMahasiswa.nim && n.type === 'mahasiswa' && !n.isRead).length;

            contentArea.innerHTML = `
                <div>
                     <h2 class="text-3xl font-bold text-gray-900 mb-6">Dashboard Mahasiswa</h2>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-blue-50 border border-blue-200 p-6 rounded-2xl">
                            <h3 class="text-lg font-semibold text-blue-900">IPK Saat Ini</h3>
                            <p class="text-4xl font-bold text-blue-600 mt-2">${currentMahasiswa.ipk}</p>
                        </div>
                        <div class="bg-indigo-50 border border-indigo-200 p-6 rounded-2xl">
                            <h3 class="text-lg font-semibold text-indigo-900">Total SKS</h3>
                            <p class="text-4xl font-bold text-indigo-600 mt-2">${currentMahasiswa.totalSks}</p>
                        </div>
                         <div class="bg-yellow-50 border border-yellow-200 p-6 rounded-2xl">
                            <h3 class="text-lg font-semibold text-yellow-900">Status KRS</h3>
                            <p class="text-2xl font-bold text-yellow-600 mt-2">${krs ? krs.status : 'Belum Mengajukan'}</p>
                        </div>
                     </div>
                     
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div id="dashboard-notifications">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Pemberitahuan Terbaru (${unreadNotifs})</h3>
                        </div>
                        <div id="dashboard-consultations">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Jadwal Konsultasi Anda</h3>
                        </div>
                     </div>
                </div>
            `;
            // Load content into dashboard widgets
            const notifContainer = document.getElementById('dashboard-notifications');
            const myNotifications = notifications.filter(n => n.recipient === currentMahasiswa.nim && n.type === 'mahasiswa').slice(0, 3);
            if (myNotifications.length > 0) {
                 notifContainer.innerHTML += myNotifications.map(n => `<div class="text-sm p-3 bg-gray-50 rounded-md mb-2">${n.message}</div>`).join('');
            } else {
                 notifContainer.innerHTML += `<p class="text-sm text-gray-500">Tidak ada pemberitahuan baru.</p>`;
            }

            const consultContainer = document.getElementById('dashboard-consultations');
            const myConsultations = konsultasiRequests.filter(r => r.nim === currentMahasiswa.nim && r.status === 'Approved');
             if (myConsultations.length > 0) {
                 consultContainer.innerHTML += myConsultations.map(c => `<div class="text-sm p-3 bg-green-50 rounded-md mb-2">Disetujui: ${c.proposedDate} pukul ${c.proposedTime}</div>`).join('');
            } else {
                 consultContainer.innerHTML += `<p class="text-sm text-gray-500">Tidak ada jadwal konsultasi yang disetujui.</p>`;
            }
        }

        function loadProfilAkademik() {
             if (!currentMahasiswa) return;
            const contentArea = document.getElementById('contentArea');
            
            let dosenWaliName = 'Belum ditentukan';
            let dosenWaliNip = null;
            for (const nip in dosenWaliMap) {
                if (dosenWaliMap[nip].includes(currentMahasiswa.nim)) {
                    dosenWaliNip = nip;
                    break;
                }
            }
            if (dosenWaliNip) {
                dosenWaliName = userData.find(u => u.nip === dosenWaliNip)?.nama || 'N/A';
            }

            const approvedKrs = krsSubmissions.find(k => k.nim === currentMahasiswa.nim && k.status === 'Approved');
            let krsContent = `<p class="text-center text-gray-500 py-6">KRS Anda belum disetujui atau belum diajukan.</p>`;
            if (approvedKrs) {
                const totalSks = approvedKrs.courses.reduce((acc, code) => acc + (academicData.find(c => c.kode === code)?.sks || 0), 0);
                krsContent = `
                    <p class="mb-2 text-sm">Total SKS yang disetujui: <strong>${totalSks}</strong></p>
                    <ul class="list-decimal list-inside space-y-1 text-sm text-gray-700">
                        ${approvedKrs.courses.map(code => {
                            const course = academicData.find(c => c.kode === code);
                            return `<li>${course.nama} (${course.sks} SKS)</li>`;
                        }).join('')}
                    </ul>
                `;
            }

            contentArea.innerHTML = `
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Profil Akademik</h2>
                    <div class="bg-white border rounded-lg p-6 space-y-4">
                        <p><strong>Nama:</strong> ${currentMahasiswa.nama}</p>
                        <p><strong>NIM:</strong> ${currentMahasiswa.nim}</p>
                        <p><strong>Email:</strong> ${currentMahasiswa.email}</p>
                        <p><strong>Dosen Wali:</strong> ${dosenWaliName}</p>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold mb-3">KRS Disetujui (${currentActiveYear})</h3>
                        <div class="bg-white border rounded-lg p-6">
                            ${krsContent}
                        </div>
                    </div>
                </div>
            `;
        }

        function loadPermintaanKonsultasi() {
             if (!currentMahasiswa) return;
            const contentArea = document.getElementById('contentArea');

            let dosenWaliNip = Object.keys(dosenWaliMap).find(nip => dosenWaliMap[nip].includes(currentMahasiswa.nim));
            if (!dosenWaliNip) {
                contentArea.innerHTML = `<p class="text-center text-gray-500 py-10">Dosen Wali Anda belum ditentukan. Hubungi admin.</p>`;
                return;
            }

            const myRequests = konsultasiRequests.filter(r => r.nim === currentMahasiswa.nim);
            
            contentArea.innerHTML = `
                <div>
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900">Permintaan Konsultasi</h2>
                        <button onclick="showRequestConsultationModal('${dosenWaliNip}')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium">
                            Ajukan Jadwal Baru
                        </button>
                     </div>
                     <h3 class="text-lg font-semibold mb-3">Riwayat Permintaan Anda</h3>
                     <div id="requestHistory" class="space-y-3"></div>
                </div>
            `;
            renderRequestHistory();
        }

        function renderRequestHistory() {
            const historyContainer = document.getElementById('requestHistory');
            if (!historyContainer) return;

            const myRequests = konsultasiRequests.filter(r => r.nim === currentMahasiswa.nim).sort((a,b) => new Date(b.proposedDate) - new Date(a.proposedDate));

            if (myRequests.length === 0) {
                historyContainer.innerHTML = `<p class="text-center text-gray-500 py-6 bg-gray-50 rounded-lg">Anda belum pernah mengajukan konsultasi.</p>`;
                return;
            }

            historyContainer.innerHTML = myRequests.map(req => {
                 const statusColors = {
                    Pending: { bg: 'bg-yellow-100', text: 'text-yellow-800' },
                    Approved: { bg: 'bg-green-100', text: 'text-green-800' },
                    Rejected: { bg: 'bg-red-100', text: 'text-red-800' }
                };
                return `
                    <div class="p-4 rounded-lg flex justify-between items-center ${statusColors[req.status].bg}">
                        <div>
                            <p><strong>${req.proposedDate}</strong> pukul ${req.proposedTime}</p>
                            <p class="text-sm text-gray-600">Topik: ${req.topic}</p>
                        </div>
                        <span class="text-xs font-bold ${statusColors[req.status].text} px-2 py-1 rounded-full">${req.status}</span>
                    </div>
                `
            }).join('');
        }

        function showRequestConsultationModal(dosenNip) {
             let modal = document.getElementById('requestConsultationModal');
            if (modal) modal.remove();
             modal = document.createElement('div');
            modal.id = 'requestConsultationModal';
            modal.className = 'hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md" role="dialog">
                    <h3 class="text-xl font-bold mb-4">Ajukan Jadwal Konsultasi</h3>
                    <form onsubmit="submitConsultationRequest('${dosenNip}', event)">
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label class="text-sm">Tanggal</label>
                                <input type="date" id="consultationDate" class="w-full mt-1 border-gray-300 rounded-md" required>
                             </div>
                             <div>
                                <label class="text-sm">Waktu</label>
                                <input type="time" id="consultationTime" class="w-full mt-1 border-gray-300 rounded-md" required>
                             </div>
                        </div>
                        <div class="mt-4">
                            <label class="text-sm">Topik yang ingin didiskusikan:</label>
                            <textarea id="consultationTopic" class="w-full mt-1 border-gray-300 rounded-md" rows="3" required></textarea>
                        </div>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button type="button" onclick="closeModal('requestConsultationModal')" class="bg-gray-200 px-4 py-2 rounded-lg">Batal</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Kirim Permintaan</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modalsContainer').appendChild(modal);
            showModal('requestConsultationModal');
        }

        function submitConsultationRequest(dosenNip, event) {
            event.preventDefault();
            const proposedDate = document.getElementById('consultationDate').value;
            const proposedTime = document.getElementById('consultationTime').value;
            const topic = document.getElementById('consultationTopic').value;
            
            const newRequest = {
                id: Math.max(...konsultasiRequests.map(r => r.id), 0) + 1,
                nim: currentMahasiswa.nim,
                dosenNip,
                proposedDate,
                proposedTime,
                topic,
                status: 'Pending'
            };
            konsultasiRequests.push(newRequest);

             // Create notification for lecturer
            const newNotif = {
                id: Math.max(...notifications.map(n => n.id), 0) + 1,
                recipient: dosenNip,
                type: 'dosen',
                message: `Mahasiswa ${currentMahasiswa.nama} (${currentMahasiswa.nim}) mengajukan permintaan konsultasi.`,
                date: new Date().toISOString().split('T')[0],
                isRead: false
            };
            notifications.push(newNotif);

            closeModal('requestConsultationModal');
            showAlert('Permintaan konsultasi berhasil dikirim.');
            loadPermintaanKonsultasi();
        }

        function loadCatatanPerwalianMahasiswa() {
             if (!currentMahasiswa) return;
            const contentArea = document.getElementById('contentArea');
            const notes = perwalianNotes
                .filter(n => n.nim === currentMahasiswa.nim)
                .sort((a,b) => new Date(a.date) - new Date(b.date));
            
            let notesHtml = notes.map(note => `
                <div class="p-4 rounded-lg ${note.author === 'Dosen' ? 'bg-blue-50' : 'bg-green-50'}">
                    <p class="text-xs font-bold ${note.author === 'Dosen' ? 'text-blue-700' : 'text-green-700'}">CATATAN DARI ${note.author.toUpperCase()} - ${note.date}</p>
                    <p class="text-sm mt-1 text-gray-800">${note.note}</p>
                </div>
            `).join('');

            if(notes.length === 0) {
                notesHtml = `<p class="text-center text-gray-500 py-10">Belum ada catatan perwalian.</p>`;
            }

            contentArea.innerHTML = `
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Catatan Perwalian</h2>
                    <div class="space-y-4 mb-6">${notesHtml}</div>
                    <form onsubmit="saveMahasiswaNote(event)" class="bg-white border rounded-lg p-4">
                        <h3 class="font-semibold mb-2">Tambah Catatan Anda</h3>
                        <textarea id="mahasiswaNote" class="w-full border-gray-300 rounded-md" rows="4" placeholder="Tulis catatan tambahan di sini..."></textarea>
                        <button type="submit" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-md">Simpan</button>
                    </form>
                </div>
            `;
        }

        function saveMahasiswaNote(event) {
            event.preventDefault();
            const noteContent = document.getElementById('mahasiswaNote').value;
            if (!noteContent.trim()) return;

            const newNote = {
                id: Math.max(...perwalianNotes.map(n => n.id), 0) + 1,
                nim: currentMahasiswa.nim,
                dosenNip: null, // Note from student doesn't need dosen nip
                date: new Date().toISOString().substr(0, 10),
                note: noteContent,
                author: 'Mahasiswa'
            };
            perwalianNotes.push(newNote);
            loadCatatanPerwalianMahasiswa();
            showAlert('Catatan Anda berhasil ditambahkan.');
        }

        function loadPemberitahuan() {
             if (!currentMahasiswa) return;
            const contentArea = document.getElementById('contentArea');
            const myNotifications = notifications
                .filter(n => n.recipient === currentMahasiswa.nim && n.type === 'mahasiswa')
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            let notifsHtml = myNotifications.map(n => `
                <div class="border-l-4 ${n.isRead ? 'border-gray-300' : 'border-blue-500'} bg-white p-4 rounded-r-lg shadow-sm">
                    <p class="text-sm">${n.message}</p>
                    <p class="text-xs text-gray-500 mt-1">${n.date}</p>
                </div>
            `).join('');
            
            if(myNotifications.length === 0) {
                notifsHtml = `<p class="text-center text-gray-500 py-10">Tidak ada pemberitahuan.</p>`;
            }
            
            // Mark all as read after loading
            myNotifications.forEach(n => n.isRead = true);

            contentArea.innerHTML = `
                 <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Pemberitahuan</h2>
                    <div class="space-y-3">${notifsHtml}</div>
                </div>`;
        }


    </script>
</body>
</html>


