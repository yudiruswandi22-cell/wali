<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Perwalian STAI Al-Mas'udiyah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menambahkan sedikit style untuk transisi dan tampilan yang lebih halus */
        body { font-family: 'Inter', sans-serif; }
        .notification { transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <div id="app">
        <!-- Konten aplikasi akan dirender di sini oleh JavaScript -->
        <div class="text-center p-10 flex-grow flex items-center justify-center">Memuat aplikasi...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, collection, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Konfigurasi Firebase ---
        // PENTING: Jika Anda mem-publish aplikasi ini secara mandiri (di luar environment khusus),
        // ganti placeholder di bawah ini dengan konfigurasi Firebase Anda sendiri dari project Firebase Console.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { 
                apiKey: "AIzaSyCDx6uqqknaP_ojGvUYGepKbZWnouRyc8c", 
                authDomain: "perwalian-fbd6f.firebaseapp.com", 
                projectId: "perwalian-fbd6f",
                storageBucket: "perwalian-fbd6f.firebasestorage.app",
                messagingSenderId: "571888446906",
                appId: "1:571888446906:web:95d5e6e508698a72eb8183"
                // Pastikan semua properti konfigurasi Firebase Anda ada di sini
            };
        // --- ID Aplikasi ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'perwalian-stai-sukabumi';
        
        const appContainer = document.getElementById('app');

        // --- Inisialisasi Firebase ---
        let app, auth, db;
        try {
            // Periksa apakah konfigurasi masih placeholder
            if (firebaseConfig.apiKey.startsWith("GANTI_DENGAN")) {
                throw new Error("Konfigurasi Firebase masih menggunakan nilai placeholder.");
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("GAGAL INISIALISASI FIREBASE:", error);
            // Render pesan galat yang jelas kepada pengguna
            const header = AppHeaderHTML ? AppHeaderHTML() : '';
            const footer = AppFooterHTML ? AppFooterHTML() : '';
            appContainer.innerHTML = `
                ${header}
                <main class="flex-grow flex items-center justify-center p-4">
                    <div class="w-full max-w-lg bg-white p-8 rounded-lg shadow-xl text-center border-t-4 border-red-500">
                        <h1 class="text-2xl font-bold text-red-600 mb-4">Gagal Memuat Aplikasi</h1>
                        <p class="text-gray-700 mb-2">Terjadi masalah saat menyambungkan ke database.</p>
                        <p class="text-gray-600">Pastikan Anda telah mengganti nilai placeholder seperti <code class="bg-red-100 text-red-800 p-1 rounded">'GANTI_DENGAN_API_KEY_ANDA'</code> di dalam file HTML dengan kunci konfigurasi asli dari proyek Firebase Anda.</p>
                        <p class="mt-4 text-sm text-gray-500">Lihat konsol browser (F12) untuk detail teknis galat.</p>
                    </div>
                </main>
                ${footer}
            `;
            // Hentikan eksekusi script lebih lanjut
            throw new Error("Inisialisasi Firebase gagal. Script dihentikan.");
        }


        // --- State Aplikasi (Global Scope) ---
        let state = {
            currentUser: null,
            isAuthReady: false,
            allUsers: {},
            dosenList: [],
            mahasiswaList: [],
            loadingUsers: true,
            notification: null,
            modal: { isOpen: false, type: '', data: null },
            selectedStudentId: null,
            academicYears: [],
            activeAcademicYear: null,
            loadingSettings: true,
        };

        // --- FUNGSI RENDER UTAMA ---
        function render() {
            // Selalu render header dan footer
            let contentHTML = `
                ${AppHeaderHTML()}
                <main class="flex-grow flex flex-col">${renderContent()}</main>
                ${AppFooterHTML()}
                ${NotificationComponentHTML(state.notification)}
            `;
            appContainer.innerHTML = contentHTML;
            attachEventListeners();
        }
        
        function renderContent() {
             if (!state.isAuthReady || state.loadingUsers || state.loadingSettings) {
                return `<div class="text-center p-10 flex-grow flex items-center justify-center">Memuat data pengguna...</div>`;
            }

            const usersForLogin = { ...state.allUsers, 'admin_001': { id: 'admin_001', name: 'Administrator', role: 'admin' } };

            if (!state.currentUser) {
                return LoginPageHTML(usersForLogin);
            }
            if (state.currentUser.role === 'admin') {
                return AdminDashboardHTML(state.allUsers, state.dosenList, state.mahasiswaList);
            }
            if (state.currentUser.role === 'dosen') {
                if (state.selectedStudentId) {
                    return PerwalianChannelHTML(state.currentUser, state.selectedStudentId, state.allUsers);
                }
                return DosenDashboardHTML(state.currentUser, state.mahasiswaList);
            }
            if (state.currentUser.role === 'mahasiswa') {
                 return PerwalianChannelHTML(state.currentUser, state.currentUser.lecturerId, state.allUsers);
            }
            return `<div>Terjadi kesalahan. Role tidak dikenali.</div>`;
        }
        
        // --- EVENT LISTENERS ATTACHER ---
        function attachEventListeners() {
            // Notifikasi
            const notifCloseBtn = document.getElementById('notif-close-btn');
            if (notifCloseBtn) notifCloseBtn.addEventListener('click', () => {
                state.notification = null;
                render();
            });

            // Login
            const loginForm = document.getElementById('login-form');
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            
            // Logout & Navigasi
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            const backBtn = document.getElementById('back-btn');
            if(backBtn) backBtn.addEventListener('click', () => {
                if (state.currentUser.role === 'mahasiswa') handleLogout();
                else {
                    state.selectedStudentId = null;
                    render();
                }
            });
            
            // Admin Dashboard Buttons
            const addDosenBtn = document.getElementById('add-dosen-btn');
            if(addDosenBtn) addDosenBtn.addEventListener('click', () => openModal('addDosen'));

            document.querySelectorAll('.edit-dosen-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const dosenId = e.currentTarget.dataset.id;
                    openModal('editDosen', state.allUsers[dosenId]);
                });
            });

            document.querySelectorAll('.delete-dosen-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const dosenId = e.currentTarget.dataset.id;
                    handleDeleteUser(dosenId, 'dosen');
                });
            });

            const addMhsBtn = document.getElementById('add-mhs-btn');
            if(addMhsBtn) addMhsBtn.addEventListener('click', () => openModal('addMhs'));
            
            document.querySelectorAll('.edit-mhs-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mhsId = e.currentTarget.dataset.id;
                    openModal('editMhs', state.allUsers[mhsId]);
                });
            });
            
             document.querySelectorAll('.delete-mhs-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mhsId = e.currentTarget.dataset.id;
                    handleDeleteUser(mhsId, 'mahasiswa');
                });
            });

            // Admin: Academic Year Management
            const addYearForm = document.getElementById('add-year-form');
            if (addYearForm) addYearForm.addEventListener('submit', handleAddAcademicYear);

            const activeYearSelect = document.getElementById('active-year-select');
            if (activeYearSelect) activeYearSelect.addEventListener('change', handleSetActiveAcademicYear);

            // Modal
            const modalCloseBtn = document.getElementById('modal-close-btn');
            if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);
            
            const userForm = document.getElementById('user-form');
            if(userForm) userForm.addEventListener('submit', handleUserFormSubmit);
            
            // Dosen Dashboard
            document.querySelectorAll('.select-student-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    state.selectedStudentId = e.currentTarget.dataset.id;
                    render();
                });
            });
            
            // Perwalian Channel
            const sendMessageForm = document.getElementById('send-message-form');
            if(sendMessageForm) sendMessageForm.addEventListener('submit', handleSendMessage);

        }
        
        // --- HANDLER FUNCTIONS ---
        function setNotification(notif) {
            state.notification = notif;
            render();
            if (notif) {
                setTimeout(() => {
                    state.notification = null;
                    render();
                }, 3000);
            }
        }
        
        function openModal(type, data = null) {
            state.modal = { isOpen: true, type, data };
            render();
        }

        function closeModal() {
            state.modal = { isOpen: false, type: '', data: null };
            render();
        }
        
        function handleLogin(e) {
            e.preventDefault();
            const selectedUserId = document.getElementById('login-select').value;
            if (selectedUserId) {
                const usersForLogin = { ...state.allUsers, 'admin_001': { id: 'admin_001', name: 'Administrator', role: 'admin' } };
                state.currentUser = usersForLogin[selectedUserId];
                render();
            }
        }
        
        function handleLogout() {
            state.currentUser = null;
            state.selectedStudentId = null;
            render();
        }

        async function handleAddAcademicYear(e) {
            e.preventDefault();
            const input = document.getElementById('new-year-input');
            const year = input.value.trim();
            if (year && /^\d{4}\/\d{4}$/.test(year)) {
                // Ganti '/' dengan '-' untuk ID dokumen yang valid
                const docId = year.replace('/', '-');
                try {
                    await setDoc(doc(db, `/artifacts/${appId}/public/data/academic_years`, docId), { name: year });
                    setNotification({ type: 'success', message: `Tahun akademik ${year} berhasil ditambahkan.` });
                    input.value = '';
                } catch (error) {
                    console.error("Error adding academic year:", error);
                    setNotification({ type: 'error', message: 'Gagal menambahkan tahun akademik.' });
                }
            } else {
                setNotification({ type: 'error', message: 'Format tahun akademik tidak valid. Gunakan format YYYY/YYYY.' });
            }
        }

        async function handleSetActiveAcademicYear(e) {
            const year = e.target.value;
            try {
                await setDoc(doc(db, `/artifacts/${appId}/public/data/settings`, 'app_config'), { activeAcademicYear: year });
                setNotification({ type: 'success', message: 'Tahun akademik aktif telah diperbarui.' });
            } catch (error) {
                console.error("Error setting active academic year:", error);
                setNotification({ type: 'error', message: 'Gagal mengatur tahun akademik aktif.' });
            }
        }

        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const type = form.dataset.type;
            const id = form.dataset.id;
            
            try {
                if (type === 'addDosen') {
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/users`), { ...data, role: 'dosen' });
                    setNotification({ type: 'success', message: 'Dosen berhasil ditambahkan!' });
                } else if (type === 'editDosen') {
                    await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, id), data);
                    setNotification({ type: 'success', message: 'Data dosen berhasil diperbarui!' });
                } else if (type === 'addMhs') {
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/users`), { ...data, role: 'mahasiswa' });
                    setNotification({ type: 'success', message: 'Mahasiswa berhasil ditambahkan!' });
                } else if (type === 'editMhs') {
                    await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, id), data);
                    setNotification({ type: 'success', message: 'Data mahasiswa berhasil diperbarui!' });
                }
                closeModal();
            } catch (error) {
                console.error("Error submitting form:", error);
                setNotification({ type: 'error', message: 'Operasi gagal. Silakan coba lagi.' });
            }
        }

        async function handleDeleteUser(userId, role) {
            // This is a simple confirmation. For a real app, use a custom modal.
            if (confirm(`Apakah Anda yakin ingin menghapus ${role} ini?`)) {
                try {
                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/users`, userId));
                    setNotification({ type: 'success', message: `Data ${role} berhasil dihapus.` });
                } catch (error) {
                    console.error(`Error deleting ${role}:`, error);
                    setNotification({ type: 'error', message: `Gagal menghapus data ${role}.` });
                }
            }
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const newMessageInput = document.getElementById('new-message-input');
            const messageTypeSelect = document.getElementById('message-type-select');
            const newMessage = newMessageInput.value;
            const messageType = messageTypeSelect ? messageTypeSelect.value : 'permohonan';
            const otherUserId = e.target.dataset.otheruser;

            if (newMessage.trim() === '') {
                setNotification({ type: 'error', message: 'Pesan tidak boleh kosong!' });
                return;
            }
            const messagePayload = {
                id: `${state.currentUser.id}_${Date.now()}`,
                senderId: state.currentUser.id,
                type: messageType,
                content: newMessage,
                timestamp: new Date().toISOString(),
            };
            const channelId = state.currentUser.role === 'dosen' ? `${state.currentUser.id}_${otherUserId}` : `${otherUserId}_${state.currentUser.id}`;
            const docRef = doc(db, `/artifacts/${appId}/public/data/perwalian_channels`, channelId);
            try {
                await updateDoc(docRef, { messages: arrayUnion(messagePayload) });
                setNotification({ type: 'success', message: 'Pesan berhasil dikirim!' });
            } catch (error) {
                if (error.code === 'not-found') {
                    await setDoc(docRef, { messages: [messagePayload] });
                     setNotification({ type: 'success', message: 'Pesan berhasil dikirim!' });
                } else {
                    console.error("Error sending message:", error);
                    setNotification({ type: 'error', message: 'Gagal mengirim pesan.' });
                }
            }
            newMessageInput.value = ''; // Clear input after send
        }
        
        // --- HTML TEMPLATE FUNCTIONS (Komponen) ---
        function AppHeaderHTML() {
            return `
            <header class="bg-green-800 text-white p-4 shadow-md w-full">
                <div class="container mx-auto flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <img src="https://iili.io/KdXnlX2.png" alt="Logo STAI Al-Mas'udiyah" class="h-12 w-12 object-contain"/>
                        <h1 class="text-xl md:text-2xl font-bold">SISTEM PERWALIAN</h1>
                    </div>
                    <span class="text-sm hidden md:block">STAI Al-Mas'udiyah Sukabumi</span>
                </div>
            </header>`;
        }
        
        function AppFooterHTML() {
            return `
            <footer class="bg-gray-800 text-white text-xs text-center p-4 mt-auto w-full">
                <p>Sekretariat STAI Al-Mas'udiyah Sukabumi: Jl. Sagaranten Km. 26 Kp. Buni Ayu Desa Kertaangsana Kec. Nyalindung Sukabumi</p>
                <p class="mt-1">Copyright &copy; 2025</p>
            </footer>`;
        }

        function NotificationComponentHTML(notification) {
            if (!notification) return '';
            const typeStyle = notification.type === 'error' ? 'bg-red-600' : 'bg-green-600';
            return `
            <div class="notification fixed top-5 right-5 text-white p-3 rounded-lg shadow-lg z-50 flex items-center ${typeStyle}">
                <span class="mr-4">${notification.message}</span>
                <button id="notif-close-btn" class="font-bold text-lg">&times;</button>
            </div>`;
        }

        function LoginPageHTML(users) {
            const userList = Object.values(users);
            const dosenList = userList.filter(u => u.role === 'dosen');
            const mahasiswaList = userList.filter(u => u.role === 'mahasiswa');

            return `
            <div class="flex-grow flex items-center justify-center p-4">
                <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-xl text-center">
                    <img src="https://iili.io/KdXnlX2.png" alt="Logo" class="h-24 w-24 mx-auto mb-4"/>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Login Sistem Perwalian</h2>
                    <p class="text-gray-600 mb-6">Silakan pilih akun Anda untuk masuk.</p>
                    <form id="login-form" class="space-y-4">
                        <select id="login-select" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500">
                            <option value="" disabled selected>-- Pilih Akun --</option>
                            <optgroup label="Administrator"><option value="admin_001">Administrator</option></optgroup>
                            <optgroup label="Dosen Wali">${dosenList.map(user => `<option value="${user.id}">${user.name}</option>`).join('')}</optgroup>
                            <optgroup label="Mahasiswa">${mahasiswaList.map(user => `<option value="${user.id}">${user.name}</option>`).join('')}</optgroup>
                        </select>
                        <button type="submit" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-gray-400">Masuk</button>
                    </form>
                </div>
            </div>`;
        }
        
        function AdminDashboardHTML(users, dosen, mahasiswa) {
            const sortedDosen = [...dosen].sort((a, b) => a.name.localeCompare(b.name));
            const sortedMahasiswa = [...mahasiswa].sort((a, b) => a.name.localeCompare(b.name));
            
            const filteredDosen = state.activeAcademicYear
                ? sortedDosen.filter(d => d.tahunAkademik === state.activeAcademicYear)
                : sortedDosen;

            const filteredMahasiswa = state.activeAcademicYear
                ? sortedMahasiswa.filter(m => m.tahunAkademik === state.activeAcademicYear)
                : sortedMahasiswa;

            return `
            <div class="container mx-auto p-4 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Manajemen Data</h2>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Keluar</button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Manajemen Tahun Akademik</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="active-year-select" class="block text-sm font-medium text-gray-700">Tampilkan Data Untuk Tahun Akademik</label>
                            <select id="active-year-select" class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                <option value="">-- Tampilkan Semua --</option>
                                ${state.academicYears.map(year => `<option value="${year.id}" ${state.activeAcademicYear === year.id ? 'selected' : ''}>${year.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="new-year-input" class="block text-sm font-medium text-gray-700">Tambah Tahun Akademik Baru</label>
                            <form id="add-year-form" class="mt-1 flex shadow-sm">
                                <input type="text" id="new-year-input" placeholder="Contoh: 2025/2026" class="w-full p-2 border-gray-300 border rounded-l-md focus:ring-green-500 focus:border-green-500" required>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r-md">Tambah</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">Data Dosen Wali</h3>
                        <button id="add-dosen-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Tambah Dosen</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Nama</th><th class="px-6 py-3">NIDN</th><th class="px-6 py-3">Jabatan</th><th class="px-6 py-3">T.A.</th><th class="px-6 py-3">Aksi</th></tr></thead>
                            <tbody>${filteredDosen.map(d => `<tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">${d.name}</td><td class="px-6 py-4">${d.nidn}</td><td class="px-6 py-4">${d.jabatan}</td><td class="px-6 py-4">${state.allUsers[d.tahunAkademik]?.name || d.tahunAkademik}</td><td class="px-6 py-4 space-x-2"><button data-id="${d.id}" class="edit-dosen-btn font-medium text-blue-600 hover:underline">Edit</button><button data-id="${d.id}" class="delete-dosen-btn font-medium text-red-600 hover:underline">Hapus</button></td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">Data Mahasiswa</h3>
                        <button id="add-mhs-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Tambah Mahasiswa</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Nama</th><th class="px-6 py-3">NIM</th><th class="px-6 py-3">Prodi</th><th class="px-6 py-3">Semester</th><th class="px-6 py-3">T.A.</th><th class="px-6 py-3">Dosen Wali</th><th class="px-6 py-3">Aksi</th></tr></thead>
                            <tbody>${filteredMahasiswa.map(m => `<tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">${m.name}</td><td class="px-6 py-4">${m.nim}</td><td class="px-6 py-4">${m.prodi}</td><td class="px-6 py-4">${m.semester}</td><td class="px-6 py-4">${state.allUsers[m.tahunAkademik]?.name || m.tahunAkademik}</td><td class="px-6 py-4">${users[m.lecturerId]?.name || 'N/A'}</td><td class="px-6 py-4 space-x-2"><button data-id="${m.id}" class="edit-mhs-btn font-medium text-blue-600 hover:underline">Edit</button><button data-id="${m.id}" class="delete-mhs-btn font-medium text-red-600 hover:underline">Hapus</button></td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>
            </div>
            ${state.modal.isOpen ? ModalHTML(state.modal.type, state.modal.data, dosen) : ''}
            `;
        }

        function DosenDashboardHTML(user, mahasiswa) {
            const mahasiswaBinaan = mahasiswa.filter(m => m.lecturerId === user.id);
             return `
            <div class="container mx-auto p-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Selamat Datang, ${user.name}</h2>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Keluar</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Pilih Mahasiswa Binaan</h3>
                    <div class="space-y-3">
                        ${mahasiswaBinaan.length > 0 ? mahasiswaBinaan.map(student => `
                            <button data-id="${student.id}" class="select-student-btn w-full text-left p-4 bg-gray-50 hover:bg-green-100 rounded-lg border border-gray-200 transition duration-300">
                                ${student.name}
                            </button>
                        `).join('') : '<p class="text-gray-500">Belum ada mahasiswa binaan.</p>'}
                    </div>
                </div>
            </div>`;
        }
        
        function ModalHTML(type, data, dosenList) {
            const title = { addDosen: 'Tambah Dosen Wali Baru', editDosen: 'Edit Data Dosen Wali', addMhs: 'Tambah Mahasiswa Baru', editMhs: 'Edit Data Mahasiswa' }[type];
            let formContent = '';
            const academicYearsOptions = state.academicYears.map(y => `<option value="${y.id}" ${data?.tahunAkademik === y.id ? 'selected' : ''}>${y.name}</option>`).join('');

            if (type.includes('Dosen')) {
                formContent = `
                    <div><label class="block text-sm font-medium">Nama Lengkap</label><input type="text" name="name" value="${data?.name || ''}" class="w-full p-2 border rounded" required /></div>
                    <div><label class="block text-sm font-medium">NIDN</label><input type="text" name="nidn" value="${data?.nidn || ''}" class="w-full p-2 border rounded" required /></div>
                    <div><label class="block text-sm font-medium">Jabatan</label><input type="text" name="jabatan" value="${data?.jabatan || ''}" class="w-full p-2 border rounded" required /></div>
                     <div><label class="block text-sm font-medium">Tahun Akademik Aktif</label><select name="tahunAkademik" class="w-full p-2 border rounded" required><option value="" disabled selected>-- Pilih Tahun --</option>${academicYearsOptions}</select></div>
                `;
            } else if (type.includes('Mhs')) {
                formContent = `
                    <div><label class="block text-sm font-medium">Nama Lengkap</label><input type="text" name="name" value="${data?.name || ''}" class="w-full p-2 border rounded" required /></div>
                    <div><label class="block text-sm font-medium">NIM</label><input type="text" name="nim" value="${data?.nim || ''}" class="w-full p-2 border rounded" required /></div>
                    <div><label class="block text-sm font-medium">Program Studi</label><select name="prodi" class="w-full p-2 border rounded"><option value="PAI" ${data?.prodi === 'PAI' ? 'selected' : ''}>PAI</option><option value="HES" ${data?.prodi === 'HES' ? 'selected' : ''}>HES</option></select></div>
                    <div><label class="block text-sm font-medium">Semester</label><input type="text" inputmode="numeric" name="semester" value="${data?.semester || ''}" class="w-full p-2 border rounded" required /></div>
                    <div><label class="block text-sm font-medium">Tahun Akademik Aktif</label><select name="tahunAkademik" class="w-full p-2 border rounded" required><option value="" disabled selected>-- Pilih Tahun --</option>${academicYearsOptions}</select></div>
                    <div><label class="block text-sm font-medium">Dosen Wali</label>
                        <select name="lecturerId" class="w-full p-2 border rounded" required>
                            <option value="" disabled>-- Pilih Dosen Wali --</option>
                            ${dosenList.map(d => `<option value="${d.id}" ${data?.lecturerId === d.id ? 'selected' : ''}>${d.name}</option>`).join('')}
                        </select>
                    </div>`;
            }
            
            return `
            <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg relative">
                    <button id="modal-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    <form id="user-form" data-type="${type}" data-id="${data?.id || ''}" class="space-y-4">
                        <h3 class="text-xl font-semibold">${title}</h3>
                        ${formContent}
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
                    </form>
                </div>
            </div>`;
        }
        
        function PerwalianChannelHTML(user, otherUserId, allUsers) {
            const otherUserName = allUsers[otherUserId]?.name || 'Memuat...';
            const channelId = user.role === 'dosen' ? `${user.id}_${otherUserId}` : `${otherUserId}_${user.id}`;
            const docRef = doc(db, `/artifacts/${appId}/public/data/perwalian_channels`, channelId);

            let messagesHTML = '<p>Memuat percakapan...</p>';
            
            // Menggunakan onSnapshot untuk real-time update, lalu render ulang bagian pesan
            onSnapshot(docRef, (docSnap) => {
                const channelData = docSnap.exists() ? docSnap.data() : { messages: [] };
                const sortedMessages = [...(channelData.messages || [])].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Ascending
                const messageContainer = document.getElementById('messages-container');
                if (messageContainer) {
                    if (sortedMessages.length > 0) {
                        messageContainer.innerHTML = sortedMessages.map(msg => {
                            const isYou = msg.senderId === user.id;
                            const senderName = isYou ? "Anda" : allUsers[msg.senderId]?.name;
                            return `
                            <div class="p-4 rounded-lg ${isYou ? 'bg-green-100 border-l-4 border-green-500' : 'bg-gray-100 border-l-4 border-gray-400'}">
                                <div class="flex justify-between items-center"><p class="font-bold text-sm text-gray-800">${senderName}</p><span class="text-xs font-semibold px-2 py-1 rounded-full ${msg.type === 'jadwal' ? 'bg-yellow-200 text-yellow-800' : 'bg-blue-200 text-blue-800'}">${msg.type}</span></div>
                                <p class="text-gray-700 mt-2">${msg.content.replace(/\n/g, '<br>')}</p>
                                <p class="text-right text-xs text-gray-500 mt-2">${new Date(msg.timestamp).toLocaleString('id-ID')}</p>
                            </div>`;
                        }).join('');
                    } else {
                        messageContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada percakapan.</p>';
                    }
                     messageContainer.scrollTop = messageContainer.scrollHeight; // Auto-scroll
                }
            });

            return `
            <div class="container mx-auto p-4 flex flex-col h-full" style="max-height: calc(100vh - 150px);">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Perwalian dengan ${otherUserName}</h2>
                    <div class="flex items-center space-x-2">
                        <button id="back-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">${user.role === 'dosen' ? 'Pilih Mahasiswa Lain' : 'Keluar'}</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg flex-grow flex flex-col overflow-hidden">
                    <form id="send-message-form" data-otheruser="${otherUserId}" class="space-y-4 mb-6 pb-6 border-b">
                        ${user.role === 'dosen' ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Jenis Pesan</label>
                            <select id="message-type-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="catatan">Catatan Hasil Perwalian</option>
                                <option value="jadwal">Jadwal Perwalian</option>
                                <option value="tanggapan">Tanggapan</option>
                            </select>
                        </div>` : ''}
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">${user.role === 'mahasiswa' ? 'Tulis Permohonan atau Tanggapan Anda' : 'Tulis Pesan Anda'}</label>
                            <textarea id="new-message-input" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ketik di sini..."></textarea>
                        </div>
                        <button type="submit" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg">Kirim</button>
                    </form>
                    <div class="flex-grow overflow-y-auto pr-2 space-y-4" id="messages-container">
                        ${messagesHTML}
                    </div>
                </div>
            </div>`;
        }

        // --- INISIALISASI APLIKASI ---
        async function initializeAppLogic() {
            // 1. Otentikasi
            const performSignIn = async () => {
                if (!auth.currentUser) {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) await signInWithCustomToken(auth, token);
                        else await signInAnonymously(auth);
                    } catch (error) {
                         console.error("Gagal otentikasi:", error);
                         // Menampilkan pesan galat yang lebih spesifik kepada pengguna
                         throw new Error("Proses otentikasi gagal. Pastikan metode login 'Anonymous' sudah diaktifkan di Firebase Console Anda pada bagian Authentication -> Sign-in method.");
                    }
                }
            };
            
            try {
                await performSignIn();

                onAuthStateChanged(auth, user => {
                    if (user && !state.isAuthReady) {
                        state.isAuthReady = true;

                        // 2. Ambil data user, tahun akademik, dan pengaturan
                        const usersColRef = collection(db, `/artifacts/${appId}/public/data/users`);
                        onSnapshot(usersColRef, (snapshot) => {
                            const usersData = {};
                            const dosen = [];
                            const mahasiswa = [];
                            snapshot.forEach(doc => {
                                const userData = { id: doc.id, ...doc.data() };
                                usersData[doc.id] = userData;
                                if (userData.role === 'dosen') dosen.push(userData);
                                else if (userData.role === 'mahasiswa') mahasiswa.push(userData);
                            });
                            state.allUsers = usersData;
                            state.dosenList = dosen;
                            state.mahasiswaList = mahasiswa;
                            state.loadingUsers = false;
                            render();
                        }, (error) => {
                            console.error("Gagal mengambil data user:", error);
                             // Menampilkan pesan galat yang lebih spesifik jika ada masalah izin
                            appContainer.innerHTML = `
                                ${AppHeaderHTML()}
                                <main class="flex-grow flex items-center justify-center p-4">
                                    <div class="w-full max-w-lg bg-white p-8 rounded-lg shadow-xl text-center border-t-4 border-red-500">
                                        <h1 class="text-2xl font-bold text-red-600 mb-4">Akses Database Ditolak</h1>
                                        <p class="text-gray-700 mb-2">Aplikasi tidak diizinkan untuk membaca data dari database.</p>
                                        <p class="text-gray-600">Ini biasanya terjadi karena aturan keamanan (Rules) di Firestore belum diatur dengan benar. Silakan periksa kembali panduan dan pastikan Anda telah mengatur Rules untuk mengizinkan akses baca/tulis.</p>
                                    </div>
                                </main>
                                ${AppFooterHTML()}
                            `;
                            state.loadingUsers = false;
                        });

                        const yearsColRef = collection(db, `/artifacts/${appId}/public/data/academic_years`);
                        onSnapshot(yearsColRef, (snapshot) => {
                            const years = [];
                            snapshot.forEach(doc => years.push({ id: doc.id, ...doc.data() }));
                            state.academicYears = years.sort((a,b) => a.id.localeCompare(b.id));
                            render();
                        });

                        const settingsDocRef = doc(db, `/artifacts/${appId}/public/data/settings`, 'app_config');
                        onSnapshot(settingsDocRef, (docSnap) => {
                            state.activeAcademicYear = docSnap.exists() ? docSnap.data().activeAcademicYear : null;
                            state.loadingSettings = false;
                            render();
                        }, (error) => {
                            console.error("Gagal mengambil pengaturan:", error);
                            state.loadingSettings = false;
                            render();
                        });
                    }
                });
                render();
            } catch(e) {
                 appContainer.innerHTML = `
                    ${AppHeaderHTML()}
                    <main class="flex-grow flex items-center justify-center p-4">
                        <div class="w-full max-w-lg bg-white p-8 rounded-lg shadow-xl text-center border-t-4 border-red-500">
                            <h1 class="text-2xl font-bold text-red-600 mb-4">Gagal Otentikasi</h1>
                            <p class="text-gray-700">${e.message}</p>
                        </div>
                    </main>
                    ${AppFooterHTML()}
                `;
                console.log("Tidak melanjutkan eksekusi script karena inisialisasi gagal.");
            }
        }
        
        initializeAppLogic();

    </script>
</body>
</html>

