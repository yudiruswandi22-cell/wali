<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Perwalian STAI Al-Mas'udiyah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Menambahkan sedikit style untuk transisi dan tampilan yang lebih halus */
        body { font-family: 'Inter', sans-serif; }
        .notification { transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <div id="app">
        <!-- Konten aplikasi akan dirender di sini oleh JavaScript -->
        <div class="text-center p-10 flex-grow flex items-center justify-center">Memuat aplikasi...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, collection, addDoc, deleteDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Konfigurasi Firebase ---
        // PENTING: Jika Anda mem-publish aplikasi ini secara mandiri (di luar environment khusus),
        // ganti placeholder di bawah ini dengan konfigurasi Firebase Anda sendiri dari project Firebase Console.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : { 
                apiKey: "AIzaSyCDx6uqqknaP_ojGvUYGepKbZWnouRyc8c", 
                authDomain: "perwalian-fbd6f.firebaseapp.com", 
                projectId: "perwalian-fbd6f",
                storageBucket: "perwalian-fbd6f.firebasestorage.app",
                messagingSenderId: "571888446906",
                appId: "1:571888446906:web:95d5e6e508698a72eb8183"
                // Pastikan semua properti konfigurasi Firebase Anda ada di sini
            };


        // --- ID Aplikasi ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'perwalian-stai-sukabumi';
        
        const appContainer = document.getElementById('app');

        // --- Inisialisasi Firebase ---
        let app, auth, db;
        try {
            if (firebaseConfig.apiKey.startsWith("GANTI_DENGAN")) {
                throw new Error("Konfigurasi Firebase masih menggunakan nilai placeholder.");
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("GAGAL INISIALISASI FIREBASE:", error);
            appContainer.innerHTML = renderErrorScreen(
                "Gagal Memuat Aplikasi",
                "Pastikan Anda telah mengganti nilai placeholder seperti <code class='bg-red-100 text-red-800 p-1 rounded'>'GANTI_DENGAN_API_KEY_ANDA'</code> di dalam file HTML dengan kunci konfigurasi asli dari proyek Firebase Anda."
            );
            throw new Error("Inisialisasi Firebase gagal. Script dihentikan.");
        }


        // --- State Aplikasi (Global Scope) ---
        let state = {
            currentUser: null,
            isAuthReady: false,
            allUsers: {},
            dosenList: [],
            mahasiswaList: [],
            mataKuliahList: [],
            scheduleList: [],
            absensiList: [],
            nilaiList: [],
            sapList: [],
            krsSubmissionsList: [],
            surveiQuestions: [
                { id: 'q1', questionText: 'Dosen datang tepat waktu.' },
                { id: 'q2', questionText: 'Referensi yang digunakan dosen up to date.' },
                { id: 'q3', questionText: 'Dosen obyektif terhadap pemberian nilai.' },
                { id: 'q4', questionText: 'Kesesuaian nilai yang diberikan dengan hasil belajar.' },
                { id: 'q5', questionText: 'Kemampuan menghidupkan suasana kelas.' },
                { id: 'q6', questionText: 'Kejelasan penyampaian materi dan jawaban terhadap pertanyaan di kelas.' },
                { id: 'q7', questionText: 'Pemanfaatan media dan teknologi pembelajaran.' },
                { id: 'q8', questionText: 'Keanekaragaman cara pengukuran hasil belajar.' },
                { id: 'q9', questionText: 'Pemberian umpan balik terhadap tugas.' },
                { id: 'q10', questionText: 'Kesesuaian materi ujian dan/atau tugas dengan tujuan mata kuliah.' }
            ],
            surveiResponses: [],
            loadingUsers: true,
            loadingMataKuliah: true,
            loadingSchedule: true,
            loadingAbsensi: true,
            loadingNilai: true,
            loadingSap: true,
            loadingKrs: true,
            loadingSurvei: true,
            notification: null,
            modal: { isOpen: false, type: '', data: null },
            selectedStudentId: null,
            selectedScheduleForAbsensi: null,
            selectedLoginUser: null,
            absensiView: 'input',
            academicYears: [],
            activeAcademicYear: null,
            loadingSettings: true,
        };

        let prodiChartInstance = null;

        // --- FUNGSI RENDER UTAMA ---
        function render() {
            let contentHTML = `
                ${AppHeaderHTML()}
                <main class="flex-grow flex flex-col">${renderContent()}</main>
                ${AppFooterHTML()}
                ${NotificationComponentHTML(state.notification)}
                ${state.modal.isOpen ? ModalHTML() : ''}
            `;
            appContainer.innerHTML = contentHTML;
            attachEventListeners();
            renderCharts();
        }
        
        function renderContent() {
             if (!state.isAuthReady || state.loadingUsers || state.loadingSettings || state.loadingMataKuliah || state.loadingSchedule || state.loadingAbsensi || state.loadingNilai || state.loadingSap || state.loadingSurvei || state.loadingKrs) {
                return `<div class="text-center p-10 flex-grow flex items-center justify-center">Memuat data...</div>`;
            }

            const usersForLogin = { ...state.allUsers, 'admin_001': { id: 'admin_001', name: 'Administrator', role: 'admin' } };

            if (!state.currentUser) {
                return LoginPageHTML(usersForLogin);
            }
            if (state.currentUser.role === 'admin') {
                return AdminDashboardHTML();
            }
            if (state.currentUser.role === 'dosen') {
                if(state.selectedScheduleForAbsensi) {
                    return AbsensiPageHTML();
                }
                if (state.selectedStudentId) {
                    return PerwalianChannelHTML(state.currentUser, state.selectedStudentId, state.allUsers);
                }
                return DosenDashboardHTML(state.currentUser, state.mahasiswaList);
            }
            if (state.currentUser.role === 'mahasiswa') {
                 return PerwalianChannelHTML(state.currentUser, state.currentUser.lecturerId, state.allUsers);
            }
            return `<div>Terjadi kesalahan. Role tidak dikenali.</div>`;
        }

        function renderCharts() {
            const chartCanvas = document.getElementById('prodiChart');
            if (chartCanvas && state.currentUser?.role === 'dosen') {
                if (prodiChartInstance) {
                    prodiChartInstance.destroy();
                }
                const mahasiswaBinaan = state.mahasiswaList.filter(m => m.lecturerId === state.currentUser.id && m.tahunAkademik === state.currentUser.tahunAkademik);
                const paiCount = mahasiswaBinaan.filter(m => m.prodi === 'PAI').length;
                const hesCount = mahasiswaBinaan.filter(m => m.prodi === 'HES').length;

                prodiChartInstance = new Chart(chartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['PAI', 'HES'],
                        datasets: [{
                            data: [paiCount, hesCount],
                            backgroundColor: ['#16A34A', '#DC2626'], // PAI: Hijau, HES: Merah
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }
                        }
                    }
                });
            }
        }
        
        // --- EVENT LISTENERS ATTACHER ---
        function attachEventListeners() {
            const notifCloseBtn = document.getElementById('notif-close-btn');
            if (notifCloseBtn) notifCloseBtn.addEventListener('click', () => { state.notification = null; render(); });
            
            const loginSearchInput = document.getElementById('login-search-input');
            if(loginSearchInput) {
                loginSearchInput.addEventListener('input', handleLoginSearch);
                handleLoginSearch({ target: { value: '' } });
            }

            const finalLoginForm = document.getElementById('final-login-form');
            if(finalLoginForm) finalLoginForm.addEventListener('submit', handleFinalLogin);

            const backToSearchBtn = document.getElementById('back-to-search-btn');
            if(backToSearchBtn) backToSearchBtn.addEventListener('click', () => {
                state.selectedLoginUser = null;
                render();
            });

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            const backBtn = document.getElementById('back-btn');
            if(backBtn) backBtn.addEventListener('click', () => {
                if (state.currentUser.role === 'mahasiswa') handleLogout();
                else { state.selectedStudentId = null; state.selectedScheduleForAbsensi = null; render(); }
            });
            
            if (state.currentUser?.role === 'admin') {
                document.getElementById('add-dosen-btn')?.addEventListener('click', () => openModal('addDosen'));
                document.querySelectorAll('.edit-dosen-btn').forEach(btn => btn.addEventListener('click', (e) => openModal('editDosen', state.allUsers[e.currentTarget.dataset.id])));
                document.querySelectorAll('.delete-dosen-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteUser(e.currentTarget.dataset.id, 'dosen')));
                document.getElementById('add-mhs-btn')?.addEventListener('click', () => openModal('addMhs'));
                document.querySelectorAll('.edit-mhs-btn').forEach(btn => btn.addEventListener('click', (e) => openModal('editMhs', state.allUsers[e.currentTarget.dataset.id])));
                document.querySelectorAll('.delete-mhs-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteUser(e.currentTarget.dataset.id, 'mahasiswa')));
                document.getElementById('add-mk-btn')?.addEventListener('click', () => openModal('addMk'));
                document.querySelectorAll('.edit-mk-btn').forEach(btn => btn.addEventListener('click', (e) => openModal('editMk', state.mataKuliahList.find(mk => mk.id === e.currentTarget.dataset.id))));
                document.querySelectorAll('.delete-mk-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteCourse(e.currentTarget.dataset.id)));
                document.getElementById('add-schedule-btn')?.addEventListener('click', () => openModal('addSchedule'));
                document.querySelectorAll('.edit-schedule-btn').forEach(btn => btn.addEventListener('click', (e) => openModal('editSchedule', state.scheduleList.find(s => s.id === e.currentTarget.dataset.id))));
                document.querySelectorAll('.delete-schedule-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteSchedule(e.currentTarget.dataset.id)));
                document.getElementById('add-year-form')?.addEventListener('submit', handleAddAcademicYear);
                document.getElementById('active-year-select')?.addEventListener('change', handleSetActiveAcademicYear);
                document.getElementById('copy-dosen-btn')?.addEventListener('click', () => openModal('copyData', { type: 'dosen', title: 'Dosen Wali' }));
                document.getElementById('copy-mhs-btn')?.addEventListener('click', () => openModal('copyData', { type: 'mahasiswa', title: 'Mahasiswa' }));
                document.getElementById('copy-mk-btn')?.addEventListener('click', () => openModal('copyData', { type: 'mata_kuliah', title: 'Mata Kuliah' }));
            }
            
            const modalCloseBtn = document.getElementById('modal-close-btn');
            if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);
            const userForm = document.getElementById('user-form');
            if(userForm) userForm.addEventListener('submit', handleUserFormSubmit);
            document.querySelectorAll('.select-student-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { state.selectedStudentId = e.currentTarget.dataset.id; render(); });
            });
            document.querySelectorAll('.input-absensi-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { 
                    state.selectedScheduleForAbsensi = state.scheduleList.find(s => s.id === e.currentTarget.dataset.scheduleid);
                    state.absensiView = 'input'; // Default to input view
                    render(); 
                });
            });

            document.querySelectorAll('.sap-accordion-toggle').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.target;
                    const target = document.getElementById(targetId);
                    if(target) {
                        target.classList.toggle('hidden');
                    }
                });
            });
            
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            if(confirmCancelBtn) confirmCancelBtn.addEventListener('click', closeModal);

            const copyDataForm = document.getElementById('copy-data-form');
            if(copyDataForm) copyDataForm.addEventListener('submit', handleCopyDataSubmit);


            attachPerwalianListeners();
            attachAbsensiListeners();
        }

        function attachPerwalianListeners() {
            const sendMessageForm = document.getElementById('send-message-form');
            if(sendMessageForm) sendMessageForm.addEventListener('submit', handleSendMessage);
            const krsForm = document.getElementById('krs-form');
            if (krsForm) {
                krsForm.addEventListener('submit', handleAjukanKrs);
                krsForm.addEventListener('change', updateTotalSks);
            }
            const approveKrsBtn = document.getElementById('approve-krs-btn');
            if (approveKrsBtn) approveKrsBtn.addEventListener('click', handleApproveKrs);
            const rejectKrsBtn = document.getElementById('reject-krs-btn');
            if (rejectKrsBtn) rejectKrsBtn.addEventListener('click', handleRejectKrs);

            document.querySelectorAll('.fill-survei-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const scheduleId = e.currentTarget.dataset.scheduleid;
                    const schedule = state.scheduleList.find(s => s.id === scheduleId);
                    openModal('fillSurvei', schedule);
                });
            });

        }

        function attachAbsensiListeners() {
            const absensiForm = document.getElementById('absensi-form');
            if(absensiForm) absensiForm.addEventListener('submit', handleSaveAbsensi);
            const pertemuanSelect = document.getElementById('pertemuan-select');
            if(pertemuanSelect) pertemuanSelect.addEventListener('change', () => { render(); });

            document.getElementById('tab-input-absensi')?.addEventListener('click', () => { state.absensiView = 'input'; render(); });
            document.getElementById('tab-rekap-absensi')?.addEventListener('click', () => { state.absensiView = 'rekap'; render(); });
            document.getElementById('tab-input-nilai')?.addEventListener('click', () => { state.absensiView = 'nilai'; render(); });
            document.getElementById('tab-input-sap')?.addEventListener('click', () => { state.absensiView = 'sap'; render(); });
            document.getElementById('tab-rekap-sap')?.addEventListener('click', () => { state.absensiView = 'rekap_sap'; render(); });
            document.getElementById('tab-feedback-survei')?.addEventListener('click', () => { state.absensiView = 'feedback'; render(); });

            document.getElementById('nilai-form')?.addEventListener('submit', handleSaveNilai);
            document.querySelectorAll('.grade-input').forEach(input => {
                input.addEventListener('input', () => {
                    const studentId = input.closest('tr').dataset.studentid;
                    updateFinalGrade(studentId);
                });
            });

            document.getElementById('sap-form')?.addEventListener('submit', handleSaveSap);
            document.getElementById('survei-form')?.addEventListener('submit', handleSaveSurvei);
        }
        
        // --- HANDLER FUNCTIONS ---
        function setNotification(notif) {
            state.notification = notif;
            render();
            if (notif) {
                setTimeout(() => { state.notification = null; render(); }, 3000);
            }
        }
        
        function openModal(type, data = null) {
            state.modal = { isOpen: true, type, data };
            render();
        }

        function closeModal() {
            state.modal = { isOpen: false, type: '', data: null };
            render();
        }
        
        function handleLoginClick(e) {
            const selectedUserId = e.currentTarget.dataset.userid;
            if (selectedUserId) {
                const usersForLogin = { ...state.allUsers, 'admin_001': { id: 'admin_001', name: 'Administrator', role: 'admin' } };
                if(selectedUserId === 'admin_001') {
                    state.currentUser = usersForLogin[selectedUserId];
                } else {
                    state.selectedLoginUser = usersForLogin[selectedUserId];
                }
                render();
            }
        }

        function handleFinalLogin(e) {
            e.preventDefault();
            const user = state.selectedLoginUser;
            if (!user) return;

            const inputId = document.getElementById('login-id-input').value.trim();
            const actualId = user.role === 'mahasiswa' ? user.nim : user.nidn;

            if (inputId === actualId) {
                state.currentUser = user;
                state.selectedLoginUser = null;
                render();
            } else {
                setNotification({ type: 'error', message: 'NIM/NIDN yang Anda masukkan salah.' });
            }
        }

        function handleLoginSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('login-results-container');
            if (!resultsContainer) return;

            const usersForLogin = { ...state.allUsers, 'admin_001': { id: 'admin_001', name: 'Administrator', role: 'admin' } };
            let userList = Object.values(usersForLogin);

            // Filter users based on the active academic year, but always include the admin
            if (state.activeAcademicYear) {
                userList = userList.filter(user => user.tahunAkademik === state.activeAcademicYear || user.role === 'admin');
            }

            const filteredUsers = userList.filter(user => user.name.toLowerCase().includes(searchTerm));

            if (filteredUsers.length > 0) {
                resultsContainer.innerHTML = filteredUsers
                    .sort((a,b) => a.name.localeCompare(b.name))
                    .map(user => {
                        const roleLabel = { admin: 'Admin', dosen: 'Dosen', mahasiswa: 'Mahasiswa'}[user.role];
                        return `
                            <button data-userid="${user.id}" class="login-user-btn w-full text-left p-3 hover:bg-gray-100 border-b last:border-b-0 transition-colors duration-150">
                                <p class="font-semibold text-gray-800">${user.name}</p>
                                <p class="text-sm text-gray-500">${roleLabel}</p>
                            </button>
                        `;
                    }).join('');
            } else {
                resultsContainer.innerHTML = `<p class="p-4 text-center text-gray-500">Tidak ada akun yang cocok.</p>`;
            }

            document.querySelectorAll('.login-user-btn').forEach(btn => {
                btn.addEventListener('click', handleLoginClick);
            });
        }
        
        function handleLogout() {
            state.currentUser = null;
            state.selectedStudentId = null;
            state.selectedScheduleForAbsensi = null;
            state.selectedLoginUser = null;
            render();
        }

        async function handleAddAcademicYear(e) {
            e.preventDefault();
            const input = document.getElementById('new-year-input');
            const year = input.value.trim();
            if (year && /^\d{4}\/\d{4} (Ganjil|Genap)$/i.test(year)) {
                const docId = year.replace('/', '-').replace(' ', '_');
                try {
                    await setDoc(doc(db, `/artifacts/${appId}/public/data/academic_years`, docId), { name: year });
                    setNotification({ type: 'success', message: `Tahun Akademik ${year} berhasil ditambahkan.` });
                    input.value = '';
                } catch (error) {
                    setNotification({ type: 'error', message: 'Gagal menambahkan tahun akademik.' });
                }
            } else {
                setNotification({ type: 'error', message: 'Format tidak valid. Gunakan "YYYY/YYYY Ganjil" atau "YYYY/YYYY Genap".' });
            }
        }

        async function handleSetActiveAcademicYear(e) {
            const yearId = e.target.value;
            try {
                await setDoc(doc(db, `/artifacts/${appId}/public/data/settings`, 'app_config'), { activeAcademicYear: yearId });
                setNotification({ type: 'success', message: 'Tahun akademik aktif telah diperbarui.' });
            } catch (error) {
                setNotification({ type: 'error', message: 'Gagal mengatur tahun akademik aktif.' });
            }
        }

        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const type = form.dataset.type;
            const id = form.dataset.id;
            
            try {
                let collectionName = '', payload = {}, successMessage = '';
                if (type.includes('Dosen')) {
                    collectionName = 'users'; payload = {...data, role: 'dosen'};
                    successMessage = type === 'addDosen' ? 'Dosen berhasil ditambahkan!' : 'Data dosen berhasil diperbarui!';
                } else if (type.includes('Mhs')) {
                    collectionName = 'users'; payload = {...data, role: 'mahasiswa'};
                    successMessage = type === 'addMhs' ? 'Mahasiswa berhasil ditambahkan!' : 'Data mahasiswa berhasil diperbarui!';
                } else if (type.includes('Mk')) {
                    collectionName = 'mata_kuliah'; payload = {...data, sks: Number(data.sks)};
                    successMessage = type === 'addMk' ? 'Mata kuliah berhasil ditambahkan!' : 'Data mata kuliah berhasil diperbarui!';
                } else if (type.includes('Schedule')) {
                    collectionName = 'jadwal_kuliah'; payload = data;
                    successMessage = type === 'addSchedule' ? 'Jadwal berhasil ditambahkan!' : 'Jadwal berhasil diperbarui!';
                }

                if(type.startsWith('add')) {
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/${collectionName}`), payload);
                } else {
                    await updateDoc(doc(db, `/artifacts/${appId}/public/data/${collectionName}`, id), payload);
                }
                setNotification({ type: 'success', message: successMessage });
                closeModal();
            } catch (error) {
                console.error("Error submitting form:", error);
                setNotification({ type: 'error', message: 'Operasi gagal. Silakan coba lagi.' });
            }
        }


        function handleDeleteUser(userId, role) {
            openModal('confirmDelete', { id: userId, collection: 'users', message: `Apakah Anda yakin ingin menghapus ${role} ini?` });
        }
        function handleDeleteCourse(courseId) {
            openModal('confirmDelete', { id: courseId, collection: 'mata_kuliah', message: 'Apakah Anda yakin ingin menghapus mata kuliah ini?' });
        }
        function handleDeleteSchedule(scheduleId) {
            openModal('confirmDelete', { id: scheduleId, collection: 'jadwal_kuliah', message: 'Apakah Anda yakin ingin menghapus jadwal ini?' });
        }
       
        async function handleConfirmDelete() {
            const { id, collection } = state.modal.data;
            if (!id || !collection) return;
            try {
                await deleteDoc(doc(db, `/artifacts/${appId}/public/data/${collection}`, id));
                setNotification({ type: 'success', message: `Data berhasil dihapus.` });
            } catch (error) {
                console.error("Error deleting document:", error);
                setNotification({ type: 'error', message: `Gagal menghapus data.` });
            } finally {
                closeModal();
            }
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const newMessageInput = document.getElementById('new-message-input');
            const newMessage = newMessageInput.value;
            const messageType = e.target.querySelector('#message-type-select')?.value || 'permohonan';
            const otherUserId = e.target.dataset.otheruser;

            if (newMessage.trim() === '') return;
            const messagePayload = {
                id: `${state.currentUser.id}_${Date.now()}`, senderId: state.currentUser.id,
                type: messageType, content: newMessage, timestamp: new Date().toISOString(),
            };
            const channelId = state.currentUser.role === 'dosen' ? `${state.currentUser.id}_${otherUserId}` : `${otherUserId}_${state.currentUser.id}`;
            const docRef = doc(db, `/artifacts/${appId}/public/data/perwalian_channels`, channelId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    await updateDoc(docRef, { messages: arrayUnion(messagePayload) });
                } else {
                    await setDoc(docRef, { messages: [messagePayload] });
                }
                setNotification({ type: 'success', message: 'Pesan berhasil dikirim!' });
                newMessageInput.value = '';
            } catch (error) { setNotification({ type: 'error', message: 'Gagal mengirim pesan.' }); }
        }

        function updateTotalSks() {
            const form = document.getElementById('krs-form');
            const totalSksEl = document.getElementById('total-sks');
            if (!form || !totalSksEl) return;
            let total = 0;
            form.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                total += Number(checkbox.dataset.sks);
            });
            totalSksEl.textContent = total;
        }

        async function handleAjukanKrs(e) {
            e.preventDefault();
            const form = e.target;
            const selectedCourses = [];
            form.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                selectedCourses.push({ id: checkbox.value, kode: checkbox.dataset.kode, nama: checkbox.dataset.nama, sks: Number(checkbox.dataset.sks) });
            });
            if (selectedCourses.length === 0) {
                setNotification({ type: 'error', message: 'Pilih minimal satu mata kuliah.' }); return;
            }
            const totalSks = selectedCourses.reduce((sum, course) => sum + course.sks, 0);
            const krsSubmission = {
                mahasiswaId: state.currentUser.id, dosenId: state.currentUser.lecturerId,
                tahunAkademik: state.currentUser.tahunAkademik, status: 'Menunggu',
                courses: selectedCourses, totalSks: totalSks, submittedAt: new Date().toISOString(),
                reviewedAt: null, dosenNotes: ''
            };
            const krsId = `${state.currentUser.tahunAkademik}_${state.currentUser.id}`;
            try {
                await setDoc(doc(db, `/artifacts/${appId}/public/data/krs_submissions`, krsId), krsSubmission);
                setNotification({ type: 'success', message: 'KRS berhasil diajukan!' });
            } catch (error) { setNotification({ type: 'error', message: 'Gagal mengajukan KRS.' }); }
        }

        async function handleApproveKrs(e) {
            const krsId = e.currentTarget.dataset.krsid;
            try {
                await updateDoc(doc(db, `/artifacts/${appId}/public/data/krs_submissions`, krsId), { status: 'Disetujui', reviewedAt: new Date().toISOString() });
                setNotification({ type: 'success', message: 'KRS telah disetujui.' });
            } catch (error) { setNotification({ type: 'error', message: 'Gagal menyetujui KRS.' }); }
        }
        
        async function handleRejectKrs(e) {
            const krsId = e.currentTarget.dataset.krsid;
            const notes = prompt("Silakan masukkan alasan penolakan (opsional):");
            try {
                await updateDoc(doc(db, `/artifacts/${appId}/public/data/krs_submissions`, krsId), { status: 'Ditolak', dosenNotes: notes || '', reviewedAt: new Date().toISOString() });
                setNotification({ type: 'success', message: 'KRS telah ditolak.' });
            } catch (error) { setNotification({ type: 'error', message: 'Gagal menolak KRS.' }); }
        }
        
        async function handleSaveAbsensi(e) {
            e.preventDefault();
            const form = e.target;
            const pertemuanKe = form.querySelector('#pertemuan-select').value;
            const scheduleId = state.selectedScheduleForAbsensi.id;
            
            const absensiData = {};
            form.querySelectorAll('.student-row').forEach(row => {
                const studentId = row.dataset.studentid;
                const status = row.querySelector('input[type="radio"]:checked').value;
                absensiData[studentId] = status;
            });

            const absensiDocId = `${scheduleId}_${pertemuanKe}`;
            try {
                await setDoc(doc(db, `/artifacts/${appId}/public/data/absensi`, absensiDocId), {
                    scheduleId: scheduleId,
                    pertemuanKe: Number(pertemuanKe),
                    tanggal: new Date().toISOString(),
                    absensiData: absensiData
                });
                setNotification({type: 'success', message: `Absensi pertemuan ke-${pertemuanKe} berhasil disimpan.`});
            } catch(error) {
                console.error("Error saving attendance:", error);
                setNotification({type: 'error', message: 'Gagal menyimpan absensi.'});
            }
        }

        async function handleSaveNilai(e) {
            e.preventDefault();
            const form = e.target;
            const scheduleId = state.selectedScheduleForAbsensi.id;
            const gradesData = {};
            form.querySelectorAll('.student-row').forEach(row => {
                const studentId = row.dataset.studentid;
                gradesData[studentId] = {
                    tugas: Number(row.querySelector('input[name="tugas"]').value),
                    uts: Number(row.querySelector('input[name="uts"]').value),
                    uas: Number(row.querySelector('input[name="uas"]').value),
                    kehadiran: Number(row.querySelector('.kehadiran-score').textContent),
                    nilaiAkhir: Number(row.querySelector('.nilai-akhir').textContent),
                    nilaiHuruf: row.querySelector('.nilai-huruf').textContent
                };
            });
            try {
                await setDoc(doc(db, `/artifacts/${appId}/public/data/nilai_mahasiswa`, scheduleId), {
                    scheduleId: scheduleId,
                    gradesData: gradesData
                }, { merge: true });
                 setNotification({type: 'success', message: `Nilai berhasil disimpan.`});
            } catch(error) {
                console.error("Error saving grades:", error);
                setNotification({type: 'error', message: 'Gagal menyimpan nilai.'});
            }
        }

        async function handleSaveSap(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const pertemuanKe = document.getElementById('pertemuan-select-sap').value;
            const scheduleId = state.selectedScheduleForAbsensi.id;
            const sapDocId = `${scheduleId}_${pertemuanKe}`;
            
            const payload = { ...data, scheduleId, pertemuanKe: Number(pertemuanKe) };
            
            try {
                await setDoc(doc(db, `/artifacts/${appId}/public/data/sap`, sapDocId), payload);
                setNotification({ type: 'success', message: `SAP untuk pertemuan ke-${pertemuanKe} berhasil disimpan.` });
            } catch (error) {
                console.error("Error saving SAP:", error);
                setNotification({ type: 'error', message: 'Gagal menyimpan SAP.' });
            }
        }
        
         async function handleSaveSurvei(e) {
            e.preventDefault();
            const form = e.target;
            const scheduleId = form.dataset.scheduleid;
            const schedule = state.scheduleList.find(s => s.id === scheduleId);
            if (!schedule) return;

            const responses = [];
            let allAnswered = true;
            state.surveiQuestions.forEach(q => {
                const ratingInput = form.querySelector(`input[name="rating-${q.id}"]:checked`);
                if (ratingInput) {
                    responses.push({ questionId: q.id, questionText: q.questionText, rating: Number(ratingInput.value) });
                } else {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                setNotification({ type: 'error', message: 'Harap isi semua pertanyaan survei.' });
                return;
            }

            const submission = {
                scheduleId: schedule.id,
                mataKuliahId: schedule.mataKuliahId,
                dosenId: schedule.dosenId,
                mahasiswaId: state.currentUser.id,
                tahunAkademik: state.currentUser.tahunAkademik,
                submittedAt: new Date().toISOString(),
                responses: responses
            };
            const responseDocId = `${schedule.id}_${state.currentUser.id}`;
            try {
                await setDoc(doc(db, `/artifacts/${appId}/public/data/survei_responses`, responseDocId), submission);
                setNotification({ type: 'success', message: 'Terima kasih, survei Anda berhasil dikirim.' });
                closeModal();
            } catch(error) {
                console.error("Error submitting survey:", error);
                setNotification({ type: 'error', message: 'Gagal mengirim survei.' });
            }
        }
        
        function updateFinalGrade(studentId) {
            const row = document.querySelector(`.student-row[data-studentid="${studentId}"]`);
            if (!row) return;

            const tugas = Number(row.querySelector('input[name="tugas"]').value) || 0;
            const uts = Number(row.querySelector('input[name="uts"]').value) || 0;
            const uas = Number(row.querySelector('input[name="uas"]').value) || 0;
            const kehadiran = Number(row.querySelector('.kehadiran-score').textContent) || 0;

            const nilaiAkhir = (tugas * 0.2) + (uts * 0.3) + (uas * 0.4) + (kehadiran * 0.1);
            
            let nilaiHuruf = 'D';
            if (nilaiAkhir >= 80) nilaiHuruf = 'A';
            else if (nilaiAkhir >= 70) nilaiHuruf = 'B';
            else if (nilaiAkhir >= 60) nilaiHuruf = 'C';

            row.querySelector('.nilai-akhir').textContent = nilaiAkhir.toFixed(1);
            row.querySelector('.nilai-huruf').textContent = nilaiHuruf;
        }

        async function handleCopyDataSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const sourceYearId = form.querySelector('#source-year-select').value;
            const destinationYearId = state.activeAcademicYear;
            const dataType = state.modal.data.type;
            const collectionName = dataType === 'dosen' || dataType === 'mahasiswa' ? 'users' : 'mata_kuliah';

            if (!sourceYearId || !destinationYearId) {
                setNotification({type: 'error', message: 'Tahun akademik sumber dan tujuan harus dipilih.'});
                return;
            }
            if(sourceYearId === destinationYearId) {
                 setNotification({type: 'error', message: 'Tahun akademik sumber dan tujuan tidak boleh sama.'});
                return;
            }

            try {
                setNotification({type: 'info', message: `Menyalin data...`});

                const dataToCopy = [];
                if(dataType === 'dosen') {
                    dataToCopy.push(...state.dosenList.filter(d => d.tahunAkademik === sourceYearId));
                } else if (dataType === 'mahasiswa') {
                    dataToCopy.push(...state.mahasiswaList.filter(m => m.tahunAkademik === sourceYearId));
                } else if (dataType === 'mata_kuliah') {
                     dataToCopy.push(...state.mataKuliahList.filter(mk => mk.tahunAkademik === sourceYearId));
                }

                if(dataToCopy.length === 0) {
                     setNotification({type: 'error', message: 'Tidak ada data untuk disalin dari tahun akademik sumber.'});
                     return;
                }

                const batch = writeBatch(db);
                dataToCopy.forEach(item => {
                    const newItem = { ...item };
                    delete newItem.id; // Hapus ID lama agar Firestore membuat yang baru
                    newItem.tahunAkademik = destinationYearId;
                    const newDocRef = doc(collection(db, `/artifacts/${appId}/public/data/${collectionName}`));
                    batch.set(newDocRef, newItem);
                });

                await batch.commit();
                setNotification({type: 'success', message: `Data berhasil disalin ke tahun akademik ${state.academicYears.find(y => y.id === destinationYearId)?.name}.`});
                closeModal();

            } catch (error) {
                console.error("Error copying data:", error);
                setNotification({type: 'error', message: 'Gagal menyalin data.'});
            }

        }

        // --- HTML TEMPLATE FUNCTIONS ---
        function AppHeaderHTML() { return `<header class="bg-green-800 text-white p-4 shadow-md w-full"><div class="container mx-auto flex items-center justify-between"><div class="flex items-center space-x-3"><img src="https://iili.io/KdXnlX2.png" alt="Logo STAI Al-Mas'udiyah" class="h-12 w-12 object-contain"/><h1 class="text-xl md:text-2xl font-bold">SISTEM PERWALIAN</h1></div><span class="text-sm hidden md:block">STAI Al-Mas'udiyah Sukabumi</span></div></header>`; }
        function AppFooterHTML() { return `<footer class="bg-gray-800 text-white text-xs text-center p-4 mt-auto w-full"><p>Sekretariat STAI Al-Mas'udiyah Sukabumi: Jl. Sagaranten Km. 26 Kp. Buni Ayu Desa Kertaangsana Kec. Nyalindung Sukabumi</p><p class="mt-1">Copyright &copy; 2025</p></footer>`; }
        function NotificationComponentHTML(notification) {
            if (!notification) return '';
            const typeStyle = notification.type === 'error' ? 'bg-red-600' : 'bg-green-600';
            return `<div class="notification fixed top-5 right-5 text-white p-3 rounded-lg shadow-lg z-50 flex items-center ${typeStyle}"><span class="mr-4">${notification.message}</span><button id="notif-close-btn" class="font-bold text-lg">&times;</button></div>`;
        }
        function LoginPageHTML(users) {
            if(state.selectedLoginUser) {
                const user = state.selectedLoginUser;
                const idLabel = user.role === 'mahasiswa' ? 'NIM' : 'NIDN';
                return `
                <div class="flex-grow flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-xl text-center">
                        <img src="https://iili.io/KdXnlX2.png" alt="Logo" class="h-24 w-24 mx-auto mb-4"/>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Verifikasi Akun</h2>
                        <p class="text-gray-600 mb-6">Anda login sebagai <strong class="text-gray-900">${user.name}</strong>. Silakan masukkan ${idLabel} Anda.</p>
                        <form id="final-login-form">
                            <input type="password" id="login-id-input" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Masukkan ${idLabel} di sini..." required>
                            <button type="submit" class="mt-4 w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Masuk</button>
                            <button type="button" id="back-to-search-btn" class="mt-2 w-full text-sm text-gray-600 hover:text-gray-800">Pilih akun lain</button>
                        </form>
                    </div>
                </div>`;
            }
            
            return `
            <div class="flex-grow flex items-center justify-center p-4">
                <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-xl text-center">
                    <img src="https://iili.io/KdXnlX2.png" alt="Logo" class="h-24 w-24 mx-auto mb-4"/>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Login Sistem Perwalian</h2>
                    <p class="text-gray-600 mb-6">Ketik nama Anda untuk mencari dan memilih akun.</p>
                    <div id="login-container">
                        <input type="text" id="login-search-input" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500" placeholder="Cari nama dosen atau mahasiswa...">
                        <div id="login-results-container" class="mt-2 border rounded-lg max-h-60 overflow-y-auto bg-white">
                            <!-- Hasil pencarian akan ditampilkan di sini -->
                        </div>
                    </div>
                </div>
            </div>`;
        }
        function AdminDashboardHTML() {
            const { allUsers, dosenList, mahasiswaList, mataKuliahList, scheduleList, activeAcademicYear, academicYears } = state;
            const filteredDosen = activeAcademicYear ? dosenList.filter(d => d.tahunAkademik === activeAcademicYear) : dosenList;
            const filteredMahasiswa = activeAcademicYear ? mahasiswaList.filter(m => m.tahunAkademik === activeAcademicYear) : mahasiswaList;
            const filteredMataKuliah = activeAcademicYear ? mataKuliahList.filter(mk => mk.tahunAkademik === activeAcademicYear) : mataKuliahList;
            const filteredSchedule = activeAcademicYear ? scheduleList.filter(s => s.tahunAkademik === activeAcademicYear) : scheduleList;
            return `<div class="container mx-auto p-4 space-y-6">
                <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">Manajemen Data</h2><button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Keluar</button></div>
                <div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-semibold text-gray-700 mb-4">Manajemen Tahun Akademik</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="active-year-select" class="block text-sm font-medium text-gray-700">Tampilkan Data Untuk Tahun Akademik</label><select id="active-year-select" class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"><option value="">-- Tampilkan Semua --</option>${academicYears.map(year => `<option value="${year.id}" ${activeAcademicYear === year.id ? 'selected' : ''}>${year.name}</option>`).join('')}</select></div><div><label for="new-year-input" class="block text-sm font-medium text-gray-700">Tambah Tahun Akademik Baru</label><form id="add-year-form" class="mt-1 flex shadow-sm"><input type="text" id="new-year-input" placeholder="Contoh: 2025/2026 Ganjil" class="w-full p-2 border-gray-300 border rounded-l-md focus:ring-green-500 focus:border-green-500" required><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r-md">Tambah</button></form></div></div></div>
                <div class="bg-white p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-gray-700">Manajemen Jadwal Kuliah</h3><button id="add-schedule-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Tambah Jadwal</button></div><div class="overflow-x-auto max-h-96"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Mata Kuliah</th><th class="px-6 py-3">Dosen</th><th class="px-6 py-3">Hari & Waktu</th><th class="px-6 py-3">Ruangan</th><th class="px-6 py-3">T.A.</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody>${filteredSchedule.map(s => `<tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">${mataKuliahList.find(mk => mk.id === s.mataKuliahId)?.nama || ''}</td><td class="px-6 py-4">${dosenList.find(d => d.id === s.dosenId)?.name || ''}</td><td class="px-6 py-4">${s.hari}, ${s.jamMulai}-${s.jamSelesai}</td><td class="px-6 py-4">${s.ruangan}</td><td class="px-6 py-4">${academicYears.find(y => y.id === s.tahunAkademik)?.name}</td><td class="px-6 py-4 space-x-2"><button data-id="${s.id}" class="edit-schedule-btn font-medium text-blue-600 hover:underline">Edit</button><button data-id="${s.id}" class="delete-schedule-btn font-medium text-red-600 hover:underline">Hapus</button></td></tr>`).join('')}</tbody></table></div></div>
                <div class="bg-white p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-gray-700">Data Mata Kuliah</h3><div class="flex gap-2"><button id="copy-mk-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Salin Data</button><button id="add-mk-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Tambah MK</button></div></div><div class="overflow-x-auto max-h-96"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Kode</th><th class="px-6 py-3">Nama Mata Kuliah</th><th class="px-6 py-3">SKS</th><th class="px-6 py-3">Prasyarat</th><th class="px-6 py-3">T.A.</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody>${filteredMataKuliah.map(mk => `<tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">${mk.kode}</td><td class="px-6 py-4">${mk.nama}</td><td class="px-6 py-4">${mk.sks}</td><td class="px-6 py-4">${mk.prasyarat || '-'}</td><td class="px-6 py-4">${academicYears.find(y=>y.id===mk.tahunAkademik)?.name}</td><td class="px-6 py-4 space-x-2"><button data-id="${mk.id}" class="edit-mk-btn font-medium text-blue-600 hover:underline">Edit</button><button data-id="${mk.id}" class="delete-mk-btn font-medium text-red-600 hover:underline">Hapus</button></td></tr>`).join('')}</tbody></table></div></div>
                <div class="bg-white p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-gray-700">Data Dosen Wali</h3><div class="flex gap-2"><button id="copy-dosen-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Salin Data</button><button id="add-dosen-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Tambah Dosen</button></div></div><div class="overflow-x-auto max-h-96"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Nama</th><th class="px-6 py-3">NIDN</th><th class="px-6 py-3">Jabatan</th><th class="px-6 py-3">T.A.</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody>${filteredDosen.map(d => `<tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">${d.name}</td><td class="px-6 py-4">${d.nidn}</td><td class="px-6 py-4">${d.jabatan}</td><td class="px-6 py-4">${academicYears.find(y=>y.id===d.tahunAkademik)?.name}</td><td class="px-6 py-4 space-x-2"><button data-id="${d.id}" class="edit-dosen-btn font-medium text-blue-600 hover:underline">Edit</button><button data-id="${d.id}" class="delete-dosen-btn font-medium text-red-600 hover:underline">Hapus</button></td></tr>`).join('')}</tbody></table></div></div>
                <div class="bg-white p-6 rounded-lg shadow-lg"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold text-gray-700">Data Mahasiswa</h3><div class="flex gap-2"><button id="copy-mhs-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Salin Data</button><button id="add-mhs-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Tambah Mahasiswa</button></div></div><div class="overflow-x-auto max-h-96"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Nama</th><th class="px-6 py-3">NIM</th><th class="px-6 py-3">Prodi</th><th class="px-6 py-3">Semester</th><th class="px-6 py-3">T.A.</th><th class="px-6 py-3">Dosen Wali</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody>${filteredMahasiswa.map(m => `<tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">${m.name}</td><td class="px-6 py-4">${m.nim}</td><td class="px-6 py-4">${m.prodi}</td><td class="px-6 py-4">${m.semester}</td><td class="px-6 py-4">${academicYears.find(y=>y.id===m.tahunAkademik)?.name}</td><td class="px-6 py-4">${allUsers[m.lecturerId]?.name || 'N/A'}</td><td class="px-6 py-4 space-x-2"><button data-id="${m.id}" class="edit-mhs-btn font-medium text-blue-600 hover:underline">Edit</button><button data-id="${m.id}" class="delete-mhs-btn font-medium text-red-600 hover:underline">Hapus</button></td></tr>`).join('')}</tbody></table></div></div>
            </div>`;
        }
        function DosenDashboardHTML(user, mahasiswa) {
            const mahasiswaBinaan = mahasiswa.filter(m => m.lecturerId === user.id && m.tahunAkademik === user.tahunAkademik);
            const paiCount = mahasiswaBinaan.filter(m => m.prodi === 'PAI').length;
            const hesCount = mahasiswaBinaan.filter(m => m.prodi === 'HES').length;
            const mySchedule = state.scheduleList.filter(s => s.dosenId === user.id && s.tahunAkademik === user.tahunAkademik);
             return `<div class="container mx-auto p-4 space-y-6"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800">Selamat Datang, ${user.name}</h2><button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Keluar</button></div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2 grid grid-cols-2 gap-6"><div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg flex flex-col justify-center"><h4 class="font-semibold text-lg">Mahasiswa PAI</h4><p class="text-4xl font-bold">${paiCount}</p></div><div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-xl shadow-lg flex flex-col justify-center"><h4 class="font-semibold text-lg">Mahasiswa HES</h4><p class="text-4xl font-bold">${hesCount}</p></div></div><div class="bg-white p-4 rounded-xl shadow-lg flex items-center justify-center relative"><canvas id="prodiChart"></canvas></div></div>
                <div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Jadwal Mengajar Anda (T.A. ${state.academicYears.find(y => y.id === user.tahunAkademik)?.name || user.tahunAkademik})</h3><div class="overflow-x-auto max-h-96"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Hari</th><th class="px-6 py-3">Waktu</th><th class="px-6 py-3">Mata Kuliah</th><th class="px-6 py-3">Ruangan</th><th class="px-6 py-3">Aksi</th></tr></thead><tbody>${mySchedule.length > 0 ? mySchedule.map(s => `<tr class="bg-white border-b"><td class="px-6 py-4">${s.hari}</td><td class="px-6 py-4">${s.jamMulai} - ${s.jamSelesai}</td><td class="px-6 py-4 font-medium">${state.mataKuliahList.find(mk => mk.id === s.mataKuliahId)?.nama || ''}</td><td class="px-6 py-4">${s.ruangan}</td><td class="px-6 py-4"><button data-scheduleid="${s.id}" class="input-absensi-btn text-blue-600 hover:underline font-semibold">Detail Kelas</button></td></tr>`).join('') : `<tr><td colspan="5" class="text-center py-4 text-gray-500">Tidak ada jadwal mengajar untuk tahun akademik Anda.</td></tr>`}</tbody></table></div></div>
                <div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Pilih Mahasiswa Binaan</h3><div class="overflow-y-auto max-h-96">${mahasiswaBinaan.length > 0 ? mahasiswaBinaan.map(student => `<button data-id="${student.id}" class="select-student-btn w-full text-left p-4 bg-gray-50 hover:bg-green-100 rounded-lg border-b transition duration-300">${student.name} <span class="text-sm text-gray-500">(${student.nim})</span></button>`).join('') : '<p class="text-gray-500 p-4 text-center">Belum ada mahasiswa binaan.</p>'}</div></div></div>`;
        }
        function ModalHTML() {
            const { type, data } = state.modal;
            const { dosenList, mataKuliahList, academicYears } = state;
            const title = { addDosen: 'Tambah Dosen Wali', editDosen: 'Edit Data Dosen', addMhs: 'Tambah Mahasiswa', editMhs: 'Edit Data Mahasiswa', addMk: 'Tambah Mata Kuliah', editMk: 'Edit Mata Kuliah', addSchedule: 'Tambah Jadwal Kuliah', editSchedule: 'Edit Jadwal Kuliah', fillSurvei: 'Isi Survei Kepuasan Dosen'}[type];
            let formContent = '';
            const academicYearsOptions = academicYears.map(y => `<option value="${y.id}" ${data?.tahunAkademik === y.id ? 'selected' : ''}>${y.name}</option>`).join('');
            if (type.includes('Dosen')) {
                formContent = `<div><label class="block text-sm font-medium">Nama Lengkap</label><input type="text" name="name" value="${data?.name || ''}" class="w-full p-2 border rounded" required /></div><div><label class="block text-sm font-medium">NIDN</label><input type="text" name="nidn" value="${data?.nidn || ''}" class="w-full p-2 border rounded" required /></div><div><label class="block text-sm font-medium">Jabatan</label><input type="text" name="jabatan" value="${data?.jabatan || ''}" class="w-full p-2 border rounded" required /></div><div><label class="block text-sm font-medium">Tahun Akademik</label><select name="tahunAkademik" class="w-full p-2 border rounded" required><option value="" disabled selected>-- Pilih Tahun --</option>${academicYearsOptions}</select></div>`;
            } else if (type.includes('Mhs')) {
                formContent = `<div><label class="block text-sm font-medium">Nama Lengkap</label><input type="text" name="name" value="${data?.name || ''}" class="w-full p-2 border rounded" required /></div><div><label class="block text-sm font-medium">NIM</label><input type="text" name="nim" value="${data?.nim || ''}" class="w-full p-2 border rounded" required /></div><div><label class="block text-sm font-medium">Program Studi</label><select name="prodi" class="w-full p-2 border rounded"><option value="PAI" ${data?.prodi === 'PAI' ? 'selected' : ''}>PAI</option><option value="HES" ${data?.prodi === 'HES' ? 'selected' : ''}>HES</option></select></div><div><label class="block text-sm font-medium">Semester</label><input type="text" inputmode="numeric" name="semester" value="${data?.semester || ''}" class="w-full p-2 border rounded" required /></div><div><label class="block text-sm font-medium">Tahun Akademik</label><select name="tahunAkademik" class="w-full p-2 border rounded" required><option value="" disabled selected>-- Pilih Tahun --</option>${academicYearsOptions}</select></div><div><label class="block text-sm font-medium">Dosen Wali</label><select name="lecturerId" class="w-full p-2 border rounded" required><option value="" disabled>-- Pilih Dosen Wali --</option>${dosenList.map(d => `<option value="${d.id}" ${data?.lecturerId === d.id ? 'selected' : ''}>${d.name}</option>`).join('')}</select></div>`;
            } else if (type.includes('Mk')) {
                formContent = `<div><label class="block text-sm font-medium">Kode Mata Kuliah</label><input type="text" name="kode" value="${data?.kode || ''}" class="w-full p-2 border rounded" required /></div><div><label class="block text-sm font-medium">Nama Mata Kuliah</label><input type="text" name="nama" value="${data?.nama || ''}" class="w-full p-2 border rounded" required /></div><div><label class="block text-sm font-medium">Jumlah SKS</label><input type="number" name="sks" value="${data?.sks || ''}" class="w-full p-2 border rounded" required /></div><div><label class="block text-sm font-medium">Mata Kuliah Prasyarat (Opsional)</label><input type="text" name="prasyarat" value="${data?.prasyarat || ''}" class="w-full p-2 border rounded" /></div><div><label class="block text-sm font-medium">Tahun Akademik</label><select name="tahunAkademik" class="w-full p-2 border rounded" required><option value="" disabled selected>-- Pilih Tahun --</option>${academicYearsOptions}</select></div>`;
            } else if (type.includes('Schedule')) {
                 const mataKuliahOptions = mataKuliahList.map(mk => `<option value="${mk.id}" ${data?.mataKuliahId === mk.id ? 'selected' : ''}>${mk.nama}</option>`).join('');
                 const dosenOptions = dosenList.map(d => `<option value="${d.id}" ${data?.dosenId === d.id ? 'selected' : ''}>${d.name}</option>`).join('');
                 const hariOptions = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'].map(h => `<option value="${h}" ${data?.hari === h ? 'selected' : ''}>${h}</option>`).join('');
                 formContent = `<div><label class="block text-sm font-medium">Tahun Akademik</label><select name="tahunAkademik" class="w-full p-2 border rounded" required><option value="" disabled selected>-- Pilih --</option>${academicYearsOptions}</select></div><div><label class="block text-sm font-medium">Mata Kuliah</label><select name="mataKuliahId" class="w-full p-2 border rounded" required><option value="" disabled selected>-- Pilih --</option>${mataKuliahOptions}</select></div><div><label class="block text-sm font-medium">Dosen Pengampu</label><select name="dosenId" class="w-full p-2 border rounded" required><option value="" disabled selected>-- Pilih --</option>${dosenOptions}</select></div><div><label class="block text-sm font-medium">Hari</label><select name="hari" class="w-full p-2 border rounded" required><option value="" disabled selected>-- Pilih --</option>${hariOptions}</select></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Jam Mulai</label><input type="time" name="jamMulai" value="${data?.jamMulai || ''}" class="w-full p-2 border rounded" required /></div><div><label class="block text-sm font-medium">Jam Selesai</label><input type="time" name="jamSelesai" value="${data?.jamSelesai || ''}" class="w-full p-2 border rounded" required /></div></div><div><label class="block text-sm font-medium">Ruangan</label><input type="text" name="ruangan" value="${data?.ruangan || ''}" class="w-full p-2 border rounded" required /></div>`;
            } else if (type === 'fillSurvei') {
                 formContent = `<div class="space-y-4">${state.surveiQuestions.map((q, index) => `
                    <div>
                        <p class="font-medium text-sm mb-2">${index + 1}. ${q.questionText}</p>
                        <div class="flex justify-around items-center">
                            <label class="flex flex-col items-center text-xs"><input type="radio" name="rating-${q.id}" value="1" class="h-4 w-4">1</label>
                            <label class="flex flex-col items-center text-xs"><input type="radio" name="rating-${q.id}" value="2" class="h-4 w-4">2</label>
                            <label class="flex flex-col items-center text-xs"><input type="radio" name="rating-${q.id}" value="3" class="h-4 w-4">3</label>
                            <label class="flex flex-col items-center text-xs"><input type="radio" name="rating-${q.id}" value="4" class="h-4 w-4">4</label>
                            <label class="flex flex-col items-center text-xs"><input type="radio" name="rating-${q.id}" value="5" class="h-4 w-4">5</label>
                        </div>
                    </div>`).join('')}</div>`;
                 return `<div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg relative max-h-full overflow-y-auto"><button id="modal-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button><form id="survei-form" data-scheduleid="${data.id}"><h3 class="text-xl font-semibold">${title}</h3><p class="text-sm text-gray-500 mb-4">MK: ${state.mataKuliahList.find(mk => mk.id === data.mataKuliahId)?.nama}</p>${formContent}<button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4">Kirim Survei</button></form></div></div>`;
            } else if (type === 'confirmDelete') {
                return `<div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md relative">
                        <h3 class="text-xl font-semibold mb-4">Konfirmasi Penghapusan</h3>
                        <p>${data.message}</p>
                        <div class="flex justify-end gap-4 mt-6">
                            <button type="button" id="confirm-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Batal</button>
                            <button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Ya, Hapus</button>
                        </div>
                    </div>
                </div>`;
            } else if (type === 'copyData') {
                return `<div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md relative">
                        <button id="modal-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        <form id="copy-data-form">
                            <h3 class="text-xl font-semibold mb-4">Salin Data ${data.title}</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="source-year-select" class="block text-sm font-medium text-gray-700">Salin dari Tahun Akademik:</label>
                                    <select id="source-year-select" class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm" required>
                                        <option value="" disabled selected>-- Pilih Tahun Sumber --</option>
                                        ${state.academicYears.map(y => `<option value="${y.id}">${y.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Ke Tahun Akademik (Aktif):</label>
                                    <p class="mt-1 p-2 bg-gray-100 rounded-md">${state.academicYears.find(y => y.id === state.activeAcademicYear)?.name || 'Tidak ada tahun aktif'}</p>
                                </div>
                            </div>
                            <button type="submit" class="mt-6 w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg" ${!state.activeAcademicYear ? 'disabled' : ''}>Salin Data</button>
                        </form>
                    </div>
                </div>`;
            }

            return `<div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg relative max-h-full overflow-y-auto"><button id="modal-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button><form id="user-form" data-type="${type}" data-id="${data?.id || ''}" class="space-y-4"><h3 class="text-xl font-semibold">${title}</h3>${formContent}<button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button></form></div></div>`;
        }
        function PerwalianChannelHTML(user, otherUserId, allUsers) {
            const isDosen = user.role === 'dosen';
            const mahasiswa = isDosen ? allUsers[otherUserId] : user;
            const dosen = isDosen ? user : allUsers[otherUserId];
            const otherUserName = isDosen ? mahasiswa.name : dosen.name;
            const tahunAkademikNama = state.academicYears.find(y => y.id === mahasiswa.tahunAkademik)?.name || mahasiswa.tahunAkademik;
            const krsId = `${mahasiswa.tahunAkademik}_${mahasiswa.id}`;
            const studentKrs = state.krsSubmissionsList.find(krs => krs.id === krsId);
            const isKrsApproved = studentKrs && studentKrs.status === 'Disetujui';
            const approvedCourseIds = isKrsApproved ? studentKrs.courses.map(c => c.id) : [];
            const approvedSchedule = state.scheduleList.filter(s => s.tahunAkademik === mahasiswa.tahunAkademik && approvedCourseIds.includes(s.mataKuliahId));
            const channelId = `${dosen.id}_${mahasiswa.id}`;
            onSnapshot(doc(db, `/artifacts/${appId}/public/data/krs_submissions`, krsId), (docSnap) => {
                const krsSubmission = docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
                const availableCourses = state.mataKuliahList.filter(mk => mk.tahunAkademik === mahasiswa.tahunAkademik);
                const krsContainer = document.getElementById('krs-section-container');
                if (krsContainer) {
                    krsContainer.innerHTML = KrsSectionHTML(user, krsSubmission, availableCourses);
                    attachPerwalianListeners();
                }
            });
            onSnapshot(doc(db, `/artifacts/${appId}/public/data/perwalian_channels`, channelId), (docSnap) => {
                const messages = docSnap.exists() ? docSnap.data().messages || [] : [];
                const chatContainer = document.getElementById('chat-section-container');
                 if (chatContainer) {
                    chatContainer.innerHTML = ChatSectionHTML(user, messages, allUsers, otherUserId);
                    attachPerwalianListeners();
                }
            });
            return `<div class="container mx-auto p-4">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl md:text-2xl font-bold text-gray-800">${isDosen ? `Perwalian dengan ${otherUserName}` : 'Dashboard Mahasiswa'}</h2><button id="back-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">${isDosen ? 'Pilih Mahasiswa Lain' : 'Keluar'}</button></div>
                <div class="space-y-6">
                ${!isDosen ? `<div class="bg-white p-4 rounded-lg shadow-md"><h3 class="text-lg font-semibold text-gray-800 mb-2">${mahasiswa.name}</h3><div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm text-gray-600"><div><strong>NIM:</strong> ${mahasiswa.nim}</div><div><strong>Semester:</strong> ${mahasiswa.semester}</div><div class="col-span-2"><strong>Tahun Akademik:</strong> ${tahunAkademikNama}</div></div></div>` : ''}
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col"><h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Kartu Rencana Studi (KRS)</h3><div id="krs-section-container"><div class="text-center text-gray-400">Memuat data KRS...</div></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col"><h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Diskusi Perwalian</h3><div id="chat-section-container"><div class="text-center text-gray-400">Memuat percakapan...</div></div></div>
                </div>
                ${!isDosen ? `<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Nilai Mata Kuliah</h3>${NilaiHistoryHTML(mahasiswa, approvedSchedule)}</div>
                    <div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Riwayat Absensi</h3>${AbsensiHistoryHTML(mahasiswa, approvedSchedule)}</div>
                </div>` : ''}
                ${!isDosen ? `<div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Survei Kepuasan Dosen Pengajar</h3>${SurveiStudentHTML(mahasiswa, approvedSchedule)}</div>` : ''}
                ${!isDosen ? `<div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Rencana Perkuliahan (SAP)</h3>${SapHistoryHTML(mahasiswa, approvedSchedule)}</div>` : ''}
                ${!isDosen && approvedSchedule.length > 0 ? `<div class="bg-white p-6 rounded-lg shadow-lg"><h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Jadwal Kuliah (T.A. ${tahunAkademikNama})</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">Hari</th><th class="px-4 py-2">Waktu</th><th class="px-4 py-2">Mata Kuliah</th><th class="px-4 py-2">Dosen</th><th class="px-4 py-2">Ruang</th></tr></thead><tbody>${approvedSchedule.map(s => `<tr class="border-b"><td class="px-4 py-2">${s.hari}</td><td class="px-4 py-2">${s.jamMulai}-${s.jamSelesai}</td><td class="px-4 py-2">${state.mataKuliahList.find(mk => mk.id === s.mataKuliahId)?.nama || '-'}</td><td class="px-4 py-2">${state.dosenList.find(d => d.id === s.dosenId)?.name || '-'}</td><td class="px-4 py-2">${s.ruangan}</td></tr>`).join('')}</tbody></table></div></div>` : ''}
                </div>
            </div>`;
        }
        function KrsSectionHTML(user, krsSubmission, availableCourses) {
            const isDosen = user.role === 'dosen';
            if (krsSubmission) {
                const statusColor = { 'Menunggu': 'bg-yellow-100 text-yellow-800', 'Disetujui': 'bg-green-100 text-green-800', 'Ditolak': 'bg-red-100 text-red-800'}[krsSubmission.status];
                const submissionDate = new Date(krsSubmission.submittedAt).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const reviewedDate = krsSubmission.reviewedAt ? new Date(krsSubmission.reviewedAt).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : null;
                return `<div><div class="flex justify-between items-center mb-1"><h4 class="text-lg font-semibold">${isDosen ? 'KRS Mahasiswa' : 'KRS Anda'}</h4><span class="px-3 py-1 text-sm font-bold rounded-full ${statusColor}">${krsSubmission.status}</span></div><p class="text-xs text-gray-500 mb-4">Diajukan pada: ${submissionDate}</p><div class="border rounded-lg p-4 space-y-2">${krsSubmission.courses.map(c => `<div class="flex justify-between items-center text-sm"><span>${c.kode} - ${c.nama}</span><span class="font-semibold">${c.sks} SKS</span></div>`).join('')}<div class="flex justify-between items-center font-bold border-t pt-2 mt-2"><span>Total SKS</span><span>${krsSubmission.totalSks} SKS</span></div></div>${reviewedDate ? `<p class="text-xs text-gray-500 mt-2 text-right">Ditinjau pada: ${reviewedDate}</p>` : ''}${krsSubmission.dosenNotes ? `<div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm"><p class="font-bold mb-1">Catatan dari Dosen:</p><p>${krsSubmission.dosenNotes}</p></div>` : ''}${isDosen && krsSubmission.status === 'Menunggu' ? `<div class="mt-6 flex gap-4"><button id="approve-krs-btn" data-krsid="${krsSubmission.id}" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Setujui</button><button id="reject-krs-btn" data-krsid="${krsSubmission.id}" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Tolak</button></div>` : ''}</div>`;
            } else {
                if (isDosen) return `<p class="text-center text-gray-500 py-10">Mahasiswa belum mengajukan KRS untuk tahun akademik ini.</p>`;
                return `<form id="krs-form"><h4 class="text-lg font-semibold mb-2">Pilih Mata Kuliah</h4><div class="space-y-2 max-h-64 overflow-y-auto border rounded-lg p-4 mb-4">${availableCourses.length > 0 ? availableCourses.map(mk => `<label class="flex items-center p-2 rounded-md hover:bg-gray-50"><input type="checkbox" value="${mk.id}" data-sks="${mk.sks}" data-kode="${mk.kode}" data-nama="${mk.nama}" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500"><span class="ml-3 text-sm flex-grow">${mk.kode} - ${mk.nama}</span><span class="text-sm font-semibold">${mk.sks} SKS</span></label>`).join('') : '<p class="text-gray-500">Tidak ada mata kuliah yang tersedia untuk tahun akademik Anda.</p>'}</div><div class="flex justify-between items-center font-bold text-lg mb-4"><span>Total SKS Dipilih:</span><span id="total-sks">0</span></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Ajukan KRS</button></form>`;
            }
        }
        function ChatSectionHTML(user, messages, allUsers, otherUserId) {
             const sortedMessages = [...messages].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
             return `<div class="flex-grow overflow-y-auto pr-2 space-y-4 mb-4" id="messages-container" style="min-height: 200px;">${sortedMessages.length > 0 ? sortedMessages.map(msg => { const isYou = msg.senderId === user.id; const senderName = isYou ? "Anda" : allUsers[msg.senderId]?.name; return `<div class="p-3 rounded-lg text-sm ${isYou ? 'bg-green-100' : 'bg-gray-100'}"><div class="flex justify-between items-center mb-1"><p class="font-bold text-gray-800">${senderName}</p><span class="text-xs text-gray-500">${new Date(msg.timestamp).toLocaleString('id-ID')}</span></div><p class="text-gray-700">${msg.content.replace(/\n/g, '<br>')}</p></div>`; }).join('') : '<p class="text-gray-500 text-center py-4">Belum ada percakapan.</p>'}</div><form id="send-message-form" data-otheruser="${otherUserId}" class="mt-auto">${user.role === 'dosen' ? `<select id="message-type-select" class="w-full p-2 mb-2 border border-gray-300 rounded-md shadow-sm text-sm"><option value="catatan">Catatan</option><option value="jadwal">Jadwal</option><option value="tanggapan">Tanggapan</option></select>` : ''}<textarea id="new-message-input" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ketik pesan..."></textarea><button type="submit" class="w-full mt-2 bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg">Kirim</button></form>`;
        }
        function AbsensiPageHTML() {
            const schedule = state.selectedScheduleForAbsensi;
            const mataKuliah = state.mataKuliahList.find(mk => mk.id === schedule.mataKuliahId);
            let content;
            switch(state.absensiView) {
                case 'input': content = AbsensiInputHTML(); break;
                case 'rekap': content = AbsensiRekapHTML(); break;
                case 'nilai': content = NilaiInputHTML(); break;
                case 'sap': content = SapInputHTML(); break;
                case 'rekap_sap': content = SapRekapHTML(); break;
                case 'feedback': content = FeedbackSurveiHTML(); break;
                default: content = AbsensiInputHTML();
            }
            return `<div class="container mx-auto p-4"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">Detail Kelas: ${mataKuliah.nama}</h2><button id="back-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Kembali</button></div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="border-b mb-4">
                    <nav class="flex space-x-4 overflow-x-auto pb-2">
                        <button id="tab-input-absensi" class="py-2 px-4 font-semibold whitespace-nowrap ${state.absensiView === 'input' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}">Input Absensi</button>
                        <button id="tab-rekap-absensi" class="py-2 px-4 font-semibold whitespace-nowrap ${state.absensiView === 'rekap' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}">Rekap Absensi</button>
                        <button id="tab-input-nilai" class="py-2 px-4 font-semibold whitespace-nowrap ${state.absensiView === 'nilai' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}">Input Nilai</button>
                        <button id="tab-input-sap" class="py-2 px-4 font-semibold whitespace-nowrap ${state.absensiView === 'sap' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}">Input SAP</button>
                        <button id="tab-rekap-sap" class="py-2 px-4 font-semibold whitespace-nowrap ${state.absensiView === 'rekap_sap' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}">Rekap SAP</button>
                        <button id="tab-feedback-survei" class="py-2 px-4 font-semibold whitespace-nowrap ${state.absensiView === 'feedback' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500'}">Feedback Survei</button>
                    </nav>
                </div>
                ${content}
            </div></div>`;
        }
        function AbsensiInputHTML() {
            const schedule = state.selectedScheduleForAbsensi;
            const students = state.mahasiswaList.filter(m => state.krsSubmissionsList.some(krs => krs.status === 'Disetujui' && krs.mahasiswaId === m.id && krs.courses.some(c => c.id === schedule.mataKuliahId)));
            const pertemuanKe = document.getElementById('pertemuan-select')?.value || 1;
            const absensiRecord = state.absensiList.find(a => a.scheduleId === schedule.id && a.pertemuanKe == pertemuanKe);
             return `<form id="absensi-form">
                    <div class="mb-4"><label for="pertemuan-select" class="block text-sm font-medium text-gray-700">Pilih Pertemuan Ke:</label>
                    <select id="pertemuan-select" class="mt-1 p-2 border rounded-md w-full md:w-1/4">
                        ${Array.from({length: 16}, (_, i) => `<option value="${i+1}" ${pertemuanKe == i+1 ? 'selected' : ''}>${i+1}</option>`).join('')}
                    </select></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">Nama Mahasiswa</th><th class="px-4 py-2 text-center">Hadir</th><th class="px-4 py-2 text-center">Izin</th><th class="px-4 py-2 text-center">Sakit</th><th class="px-4 py-2 text-center">Alpa</th></tr></thead>
                            <tbody>${students.map(student => {
                                const status = absensiRecord?.absensiData[student.id] || 'Hadir'; // Default to Hadir
                                return `<tr class="border-b student-row" data-studentid="${student.id}"><td class="px-4 py-2 font-medium">${student.name}</td>
                                    ${['Hadir', 'Izin', 'Sakit', 'Alpa'].map(s => `<td class="text-center"><input type="radio" name="status-${student.id}" value="${s}" ${status === s ? 'checked' : ''}></td>`).join('')}
                                </tr>`;
                            }).join('')}</tbody>
                        </table>
                    </div>
                    <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Simpan Absensi</button>
                </form>`;
        }
        function AbsensiRekapHTML() {
            const schedule = state.selectedScheduleForAbsensi;
            const students = state.mahasiswaList.filter(m => state.krsSubmissionsList.some(krs => krs.status === 'Disetujui' && krs.mahasiswaId === m.id && krs.courses.some(c => c.id === schedule.mataKuliahId)));
            const attendanceForThisSchedule = state.absensiList.filter(a => a.scheduleId === schedule.id);
            const statusColors = { H: 'bg-green-100 text-green-800', I: 'bg-blue-100 text-blue-800', S: 'bg-yellow-100 text-yellow-800', A: 'bg-red-100 text-red-800' };

            return `<div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-2 py-2">Nama Mahasiswa</th>
                                    ${Array.from({length: 16}, (_, i) => `<th class="px-2 py-2 text-center">${i+1}</th>`).join('')}
                                    <th class="px-2 py-2 text-center">H</th><th class="px-2 py-2 text-center">I</th><th class="px-2 py-2 text-center">S</th><th class="px-2 py-2 text-center">A</th>
                                </tr>
                            </thead>
                            <tbody>${students.map(student => {
                                let summary = { Hadir: 0, Izin: 0, Sakit: 0, Alpa: 0 };
                                const cells = Array.from({length: 16}, (_, i) => {
                                    const record = attendanceForThisSchedule.find(a => a.pertemuanKe == i + 1);
                                    const status = record ? record.absensiData[student.id] : null;
                                    if (status) summary[status]++;
                                    const initial = status ? status.charAt(0) : '-';
                                    const color = status ? statusColors[initial] : 'bg-gray-100';
                                    return `<td class="text-center"><span class="inline-block w-5 h-5 rounded-full ${color} font-semibold flex items-center justify-center">${initial}</span></td>`;
                                }).join('');
                                return `<tr class="border-b"><td class="px-2 py-2 font-medium">${student.name}</td>${cells}<td class="px-2 py-2 text-center font-bold">${summary.Hadir}</td><td class="px-2 py-2 text-center font-bold">${summary.Izin}</td><td class="px-2 py-2 text-center font-bold">${summary.Sakit}</td><td class="px-2 py-2 text-center font-bold">${summary.Alpa}</td></tr>`;
                            }).join('')}</tbody>
                        </table>
                    </div>`;
        }
         function NilaiInputHTML() {
            const schedule = state.selectedScheduleForAbsensi;
            const students = state.mahasiswaList.filter(m => state.krsSubmissionsList.some(krs => krs.status === 'Disetujui' && krs.mahasiswaId === m.id && krs.courses.some(c => c.id === schedule.mataKuliahId)));
            const nilaiRecord = state.nilaiList.find(n => n.id === schedule.id);
            return `<form id="nilai-form">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>
                            <th class="px-4 py-2">Nama Mahasiswa</th>
                            <th class="px-4 py-2 text-center">Tugas (20%)</th>
                            <th class="px-4 py-2 text-center">UTS (30%)</th>
                            <th class="px-4 py-2 text-center">UAS (40%)</th>
                            <th class="px-4 py-2 text-center">Kehadiran (10%)</th>
                            <th class="px-4 py-2 text-center">Nilai Akhir</th>
                            <th class="px-4 py-2 text-center">Nilai Huruf</th>
                        </tr></thead>
                        <tbody>${students.map(student => {
                            const myAbsensi = state.absensiList.filter(a => a.scheduleId === schedule.id);
                            const hadirCount = myAbsensi.filter(a => a.absensiData[student.id] === 'Hadir').length;
                            const kehadiranScore = Math.round((hadirCount / 16) * 100);
                            const existingGrade = nilaiRecord?.gradesData?.[student.id];
                            return `<tr class="border-b student-row" data-studentid="${student.id}">
                                <td class="px-4 py-2 font-medium">${student.name}</td>
                                <td><input type="number" name="tugas" min="0" max="100" class="w-20 p-1 border rounded text-center grade-input" value="${existingGrade?.tugas || ''}"></td>
                                <td><input type="number" name="uts" min="0" max="100" class="w-20 p-1 border rounded text-center grade-input" value="${existingGrade?.uts || ''}"></td>
                                <td><input type="number" name="uas" min="0" max="100" class="w-20 p-1 border rounded text-center grade-input" value="${existingGrade?.uas || ''}"></td>
                                <td class="text-center kehadiran-score">${kehadiranScore}</td>
                                <td class="text-center font-bold nilai-akhir">${existingGrade?.nilaiAkhir || '0.0'}</td>
                                <td class="text-center font-bold nilai-huruf">${existingGrade?.nilaiHuruf || 'D'}</td>
                            </tr>`;
                        }).join('')}</tbody>
                    </table>
                </div>
                <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Simpan Nilai</button>
            </form>`;
        }
        function NilaiHistoryHTML(mahasiswa, mySchedule) {
            if(!mySchedule || mySchedule.length === 0) return `<p class="text-gray-500 text-sm">Tidak ada data untuk ditampilkan. Pastikan KRS Anda sudah disetujui.</p>`;

            return `<div class="space-y-4">${mySchedule.map(schedule => {
                const mataKuliah = state.mataKuliahList.find(mk => mk.id === schedule.mataKuliahId);
                const nilaiDoc = state.nilaiList.find(n => n.id === schedule.id);
                const myGrade = nilaiDoc ? nilaiDoc.gradesData?.[mahasiswa.id] : null;
                return `<div class="border rounded-lg p-3 text-sm">
                    <p class="font-bold">${mataKuliah.nama}</p>
                    ${myGrade ? `<div class="flex justify-between items-center mt-2">
                        <span>Nilai Akhir: <span class="font-semibold">${myGrade.nilaiAkhir}</span></span>
                        <span>Nilai Huruf: <span class="font-semibold text-lg ${myGrade.nilaiHuruf === 'A' ? 'text-green-600' : 'text-gray-700'}">${myGrade.nilaiHuruf}</span></span>
                    </div>` : '<p class="text-xs text-gray-500 mt-1">Nilai belum diinput oleh dosen.</p>'}
                </div>`;
            }).join('')}</div>`;
        }
        function AbsensiHistoryHTML(mahasiswa, mySchedule) {
            if (!mySchedule || mySchedule.length === 0) return `<p class="text-gray-500 text-sm">Tidak ada data untuk ditampilkan. Pastikan KRS Anda sudah disetujui.</p>`;

            return mySchedule.map(schedule => {
                const mataKuliah = state.mataKuliahList.find(mk => mk.id === schedule.mataKuliahId);
                const myAbsensi = state.absensiList.filter(a => a.scheduleId === schedule.id);
                const summary = { Hadir: 0, Izin: 0, Sakit: 0, Alpa: 0 };
                myAbsensi.forEach(a => {
                    const status = a.absensiData[mahasiswa.id];
                    if (status) summary[status]++;
                });

                return `<div class="mb-4 border rounded-lg p-3">
                    <p class="font-bold">${mataKuliah.nama}</p>
                    <div class="flex space-x-4 text-xs mt-2">
                        <span class="font-semibold text-green-600">Hadir: ${summary.Hadir}</span>
                        <span class="font-semibold text-blue-600">Izin: ${summary.Izin}</span>
                        <span class="font-semibold text-yellow-600">Sakit: ${summary.Sakit}</span>
                        <span class="font-semibold text-red-600">Alpa: ${summary.Alpa}</span>
                    </div>
                </div>`;
            }).join('');
        }
         function SapInputHTML() {
            const schedule = state.selectedScheduleForAbsensi;
            const pertemuanKe = document.getElementById('pertemuan-select-sap')?.value || 1;
            const sapRecord = state.sapList.find(s => s.scheduleId === schedule.id && s.pertemuanKe == pertemuanKe);
             return `<form id="sap-form" class="space-y-4">
                    <div><label for="pertemuan-select-sap" class="block text-sm font-medium text-gray-700">Pilih Pertemuan Ke:</label>
                    <select id="pertemuan-select-sap" class="mt-1 p-2 border rounded-md w-full md:w-1/4">
                        ${Array.from({length: 16}, (_, i) => `<option value="${i+1}" ${pertemuanKe == i+1 ? 'selected' : ''}>${i+1}</option>`).join('')}
                    </select></div>
                    <div><label class="block text-sm font-medium">Tanggal Perkuliahan</label><input type="date" name="tanggalPerkuliahan" value="${sapRecord?.tanggalPerkuliahan || ''}" class="w-full p-2 border rounded" required /></div>
                    <div><label class="block text-sm font-medium">Capaian Pembelajaran (CPMK)</label><textarea name="cpmk" rows="3" class="w-full p-2 border rounded">${sapRecord?.cpmk || ''}</textarea></div>
                    <div><label class="block text-sm font-medium">Sub-CPMK</label><textarea name="subCpmk" rows="3" class="w-full p-2 border rounded">${sapRecord?.subCpmk || ''}</textarea></div>
                    <div><label class="block text-sm font-medium">Materi</label><textarea name="materi" rows="3" class="w-full p-2 border rounded">${sapRecord?.materi || ''}</textarea></div>
                    <div><label class="block text-sm font-medium">Model Pembelajaran</label><input type="text" name="modelPembelajaran" value="${sapRecord?.modelPembelajaran || ''}" class="w-full p-2 border rounded" /></div>
                    <div><label class="block text-sm font-medium">Catatan Pengalaman Belajar</label><textarea name="catatanPengalaman" rows="3" class="w-full p-2 border rounded">${sapRecord?.catatanPengalaman || ''}</textarea></div>
                    <div><label class="block text-sm font-medium">Refleksi</label><textarea name="refleksi" rows="3" class="w-full p-2 border rounded">${sapRecord?.refleksi || ''}</textarea></div>
                    <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Simpan SAP</button>
                </form>`;
        }
        function SapRekapHTML() {
            const schedule = state.selectedScheduleForAbsensi;
            const mySapRecords = state.sapList.filter(s => s.scheduleId === schedule.id);

            return `<div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-center">P</th>
                                    <th class="px-4 py-2">Tanggal</th>
                                    <th class="px-4 py-2">Materi Pembelajaran</th>
                                    <th class="px-4 py-2">Model Pembelajaran</th>
                                    <th class="px-4 py-2">Catatan</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Array.from({length: 16}, (_, i) => {
                                    const pertemuan = i + 1;
                                    const sapRecord = mySapRecords.find(s => s.pertemuanKe === pertemuan);
                                    return `<tr class="border-b">
                                        <td class="px-4 py-2 font-bold text-center">${pertemuan}</td>
                                        <td class="px-4 py-2">${sapRecord?.tanggalPerkuliahan || '-'}</td>
                                        <td class="px-4 py-2">${sapRecord?.materi || '-'}</td>
                                        <td class="px-4 py-2">${sapRecord?.modelPembelajaran || '-'}</td>
                                        <td class="px-4 py-2">${sapRecord?.catatanPengalaman || '-'}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
        }
        function SapHistoryHTML(mahasiswa, mySchedule) {
            if (!mySchedule || mySchedule.length === 0) return `<p class="text-gray-500 text-sm">Tidak ada data untuk ditampilkan. Pastikan KRS Anda sudah disetujui.</p>`;
            
            return `<div class="space-y-2">${mySchedule.map(schedule => {
                const mataKuliah = state.mataKuliahList.find(mk => mk.id === schedule.mataKuliahId);
                const mySap = state.sapList.filter(s => s.scheduleId === schedule.id).sort((a,b) => a.pertemuanKe - b.pertemuanKe);
                return `<div>
                    <button class="sap-accordion-toggle w-full text-left font-bold p-3 bg-gray-100 hover:bg-gray-200 rounded-md" data-target="sap-content-${schedule.id}">${mataKuliah.nama}</button>
                    <div id="sap-content-${schedule.id}" class="hidden mt-2 ml-4 border-l-2 pl-4">
                        ${mySap.length > 0 ? mySap.map(sap => `
                            <div class="mb-3 text-sm"><p class="font-semibold">Pertemuan ${sap.pertemuanKe} (${sap.tanggalPerkuliahan || 'N/A'})</p><p><strong>Materi:</strong> ${sap.materi || '-'}</p></div>
                        `).join('') : '<p class="text-sm text-gray-500">SAP belum diinput oleh dosen.</p>'}
                    </div>
                </div>`
            }).join('')}</div>`;
        }
         function SurveiStudentHTML(mahasiswa, mySchedule) {
            if (!mySchedule || mySchedule.length === 0) return `<p class="text-gray-500 text-sm">Tidak ada data untuk ditampilkan. Pastikan KRS Anda sudah disetujui.</p>`;
            return `<div class="space-y-3">${mySchedule.map(schedule => {
                const mataKuliah = state.mataKuliahList.find(mk => mk.id === schedule.mataKuliahId);
                const dosen = state.dosenList.find(d => d.id === schedule.dosenId);
                const isSubmitted = state.surveiResponses.some(r => r.scheduleId === schedule.id && r.mahasiswaId === mahasiswa.id);
                return `<div class="p-3 border rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-bold">${mataKuliah.nama}</p>
                        <p class="text-xs text-gray-500">${dosen.name}</p>
                    </div>
                    ${isSubmitted 
                        ? `<span class="text-sm font-semibold text-green-600">Sudah Diisi</span>`
                        : `<button data-scheduleid="${schedule.id}" class="fill-survei-btn bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-600">Isi Survei</button>`
                    }
                </div>`;
            }).join('')}</div>`;
        }
        function FeedbackSurveiHTML() {
            const schedule = state.selectedScheduleForAbsensi;
            const responsesForThisSchedule = state.surveiResponses.filter(r => r.scheduleId === schedule.id);
            if(responsesForThisSchedule.length === 0) return `<p class="text-center text-gray-500 py-10">Belum ada mahasiswa yang mengisi survei untuk kelas ini.</p>`;

            const results = {};
            state.surveiQuestions.forEach(q => {
                results[q.id] = { text: q.questionText, ratings: [], average: 0 };
            });

            responsesForThisSchedule.forEach(res => {
                res.responses.forEach(r => {
                    if(results[r.questionId]) {
                        results[r.questionId].ratings.push(r.rating);
                    }
                });
            });

            Object.values(results).forEach(q => {
                if(q.ratings.length > 0) {
                    q.average = q.ratings.reduce((a,b) => a+b, 0) / q.ratings.length;
                }
            });

            return `<div class="space-y-4">
                <p class="text-sm text-gray-600">Total Responden: ${responsesForThisSchedule.length}</p>
                ${Object.values(results).map(q => `
                <div class="p-3 border rounded-lg">
                    <p class="font-medium">${q.text}</p>
                    <div class="flex items-center gap-2 mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${q.average / 5 * 100}%"></div></div>
                        <span class="font-bold text-lg text-blue-700">${q.average.toFixed(1)}</span>
                    </div>
                </div>
                `).join('')}
            </div>`;
        }
        async function initializeAppLogic() {
            try {
                if (!auth.currentUser) {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) await signInWithCustomToken(auth, token);
                    else await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, user => {
                    if (user && !state.isAuthReady) {
                        state.isAuthReady = true;
                        onSnapshot(collection(db, `/artifacts/${appId}/public/data/users`), (snapshot) => {
                            const usersData = {}, dosen = [], mahasiswa = [];
                            snapshot.forEach(doc => { const userData = { id: doc.id, ...doc.data() }; usersData[doc.id] = userData; if (userData.role === 'dosen') dosen.push(userData); else if (userData.role === 'mahasiswa') mahasiswa.push(userData); });
                            state.allUsers = usersData; state.dosenList = dosen; state.mahasiswaList = mahasiswa; state.loadingUsers = false; render();
                        }, (error) => { appContainer.innerHTML = renderErrorScreen("Akses Database Ditolak", "Pastikan aturan keamanan (Rules) di Firestore sudah benar."); });
                        onSnapshot(collection(db, `/artifacts/${appId}/public/data/academic_years`), (snapshot) => {
                            const years = []; snapshot.forEach(doc => years.push({ id: doc.id, ...doc.data() }));
                            state.academicYears = years.sort((a,b) => a.id.localeCompare(b.id)); render();
                        });
                        onSnapshot(collection(db, `/artifacts/${appId}/public/data/mata_kuliah`), (snapshot) => {
                            const courses = []; snapshot.forEach(doc => courses.push({ id: doc.id, ...doc.data() }));
                            state.mataKuliahList = courses; state.loadingMataKuliah = false; render();
                        });
                        onSnapshot(collection(db, `/artifacts/${appId}/public/data/jadwal_kuliah`), (snapshot) => {
                            const schedules = []; snapshot.forEach(doc => schedules.push({ id: doc.id, ...doc.data() }));
                            state.scheduleList = schedules.sort((a,b) => a.hari.localeCompare(b.hari)); state.loadingSchedule = false; render();
                        });
                        onSnapshot(collection(db, `/artifacts/${appId}/public/data/absensi`), (snapshot) => {
                            const absensi = []; snapshot.forEach(doc => absensi.push({ id: doc.id, ...doc.data() }));
                            state.absensiList = absensi; state.loadingAbsensi = false; render();
                        });
                        onSnapshot(collection(db, `/artifacts/${appId}/public/data/nilai_mahasiswa`), (snapshot) => {
                            const nilai = []; snapshot.forEach(doc => nilai.push({ id: doc.id, ...doc.data() }));
                            state.nilaiList = nilai; state.loadingNilai = false; render();
                        });
                        onSnapshot(collection(db, `/artifacts/${appId}/public/data/sap`), (snapshot) => {
                            const sap = []; snapshot.forEach(doc => sap.push({ id: doc.id, ...doc.data() }));
                            state.sapList = sap; state.loadingSap = false; render();
                        });
                        onSnapshot(collection(db, `/artifacts/${appId}/public/data/krs_submissions`), (snapshot) => {
                            const submissions = []; snapshot.forEach(doc => submissions.push({ id: doc.id, ...doc.data() }));
                            state.krsSubmissionsList = submissions; state.loadingKrs = false; render();
                        });
                        onSnapshot(collection(db, `/artifacts/${appId}/public/data/survei_responses`), (snapshot) => {
                            const responses = []; snapshot.forEach(doc => responses.push({ id: doc.id, ...doc.data() }));
                            state.surveiResponses = responses; state.loadingSurvei = false; render();
                        });
                        onSnapshot(doc(db, `/artifacts/${appId}/public/data/settings`, 'app_config'), (docSnap) => {
                            state.activeAcademicYear = docSnap.exists() ? docSnap.data().activeAcademicYear : null; state.loadingSettings = false; render();
                        });
                    }
                });
                render();
            } catch(e) { appContainer.innerHTML = renderErrorScreen("Gagal Otentikasi", e.message); }
        }
        function renderErrorScreen(title, message) {
            return `${AppHeaderHTML()}<main class="flex-grow flex items-center justify-center p-4"><div class="w-full max-w-lg bg-white p-8 rounded-lg shadow-xl text-center border-t-4 border-red-500"><h1 class="text-2xl font-bold text-red-600 mb-4">${title}</h1><p class="text-gray-700">${message}</p></div></main>${AppFooterHTML()}`;
        }
        initializeAppLogic();
    </script>
</body>
</html>

